{"id":23997,"date":"2018-02-23T17:30:14","date_gmt":"2018-02-24T01:30:14","guid":{"rendered":"https:\/\/coert.vonk.one\/?p=23997"},"modified":"2022-04-29T20:01:31","modified_gmt":"2022-04-30T03:01:31","slug":"sonoff-mqtt-google-actions","status":"publish","type":"post","link":"/\/sw\/iot\/sonoff-mqtt-google-actions-23997","title":{"rendered":"Google IoT meets ESP32, MQTT, NodeJS"},"content":{"rendered":"<h2 class=\"nocount\">ESP32, MQTT, NodeJS and Google IoT<\/h2>\r\n<p>\r\n    This tutorial gives you a glimpse on integrating IoT devices with Google&#8217;s ecosystem.  This approach is scalable to a great many devices, has security designed in an only relies on the IoT device and Google Cloud Platform.  \r\n<\/p>\r\n<p>\r\n    This approach is more involved compared to our earlier approaches [1,2] that relied on many in between systems. This time around, the only programming will be in JavaScript (nodejs).  No opening ports on the firewall, no IFT<sup>3<\/sup>.  Plain and simple, &#8216;though never as simple as getting as opening the door to see how the weather is.  \r\n<\/p>\r\n<p>\r\n    This guide was inspired by Alvaro Viebrantz&#8217; post [3].  With MongooseOS and Google Cloud IoT still in beta, it occasionally felt like the ground was moving under my feet, but due patience and persistence makes engineering great.  With this write-up, I try to make it less daunting while providing an understanding of the inner workings.\r\n<\/p>\r\n<p>\r\n    This write-up is structured as a step-by-step guide to help you understand the elements.  If you prefer to find your own way around, feel free to head over to the GitHub repository (no longer life!). We use Windows 10, but the instructions apply to other operating systems as well. Just note that in Windows PowerShell is the character ` is used to split up long lines.\r\n<\/p>\r\n\r\n<h2>\r\n    Design\r\n<\/h2>\r\n\r\n<h3>\r\n    Goal\r\n<\/h3>\r\n<p>\r\n    The design needs to be <em>scalable<\/em>, <em>secure<\/em> and fit for <em>low-power SoC<\/em> applications.\r\n<\/p>\r\n\r\n<h3>\r\n    The lineup\r\n<\/h3>\r\n<p>\r\n    <div class=\"align-center\">\r\n        <figure>\r\n            <div class=\"flex-container tight\">\r\n                <a href=\"https:\/\/coert.vonk.one\/wp-content\/uploads\/block-diagram-overview.svg\">\r\n                    <img  title=\"\" src=\"https:\/\/coert.vonk.one\/wp-content\/uploads\/block-diagram-overview.svg\" alt=\"Block diagram: IoT integration with Google Cloud\" class=\"alignnone size-full wp-image-24414\" \/>\r\n                <\/a>\r\n            <\/div>\r\n            <figcaption>\r\n                IoT integration with Google Cloud\r\n            <\/figcaption>\r\n        <\/figure>\r\n    <\/div>\r\n<\/p>\r\n\r\n<h4>\r\n    Message Protocol\r\n<\/h4>\r\n<p>\r\n    The key ingredient is the MQTT protocol. The abbreviation MQTT stands for Message Queue Telemetry Transport, where the keyword is <em>telemetry<\/em>, or remote monitoring. Its publish\/subscription model makes it an efficient protocol that is well suited for low power devices.  By creating topics, you can enable different parts of your application to subscribe to specific streams of data. MQTT runs on the TCP transport that provides reliable delivery, but also requires devices to be awake at least some percentage of the time. The MQTT protocol is an efficient binary industry standard that allows constrained devices to send real-time telemetry as well as immediately receive messages sent from the cloud. I designed wearable products that used a phone to bridge from BTLE to MQTT in large scale deployment on AWS IoT. This time around, I will keep things as simple as possible while still keeping the design criteria front and center. \r\n<\/p>\r\n\r\n<h4>\r\n    The &#8220;thing&#8221;\r\n<\/h4>\r\n<p>\r\n    To keep things simple we an Espressif ESP32 System-on-a-Chip (SoC) that has builtin WiFi support. It would not be my first choice for low power, but it is cheap and is well supported.  We connect a simple temperature and humidity sensor to generate some data.  Feel free to use whatever other sensor comes to mind.\r\n<\/p>\r\n\r\n<h4>\r\n    Google Cloud Platform\r\n<\/h4>\r\n<p>\r\n    On the backend, we use the Google Cloud Platform that recently introduced MQTT support as &#8220;Cloud IoT&#8221;. The SoC will publish its readings to Cloud IoT, from where they are stored. For visualization we use the Data Studio tool. The block diagram at the beginning of this chapter shows the data flow. [4]\r\n<\/p>\r\n\r\n<h5>\r\n    Cloud IoT Core\r\n<\/h5>\r\n<p>\r\n    IoT Core handles registration, authentication and authorization inside the Cloud Platform resource hierarchy. It connects to Cloud Pub\/Sub to provide a secure MQTT broker service.  It also provides the ability to send device configuration to devices.\r\n<\/p>\r\n\r\n<h5>\r\n    Cloud Pub\/Sub\r\n<\/h5>\r\n<p>\r\n    Google Cloud Pub\/Sub implements MQTT by providing a globally durable message ingestion service. Cloud Pub\/Sub can act like a shock absorber and rate leveler for both incoming data streams and application architecture changes. Many devices have limited ability to store and retry sending telemetry data. Cloud Pub\/Sub scales to handle data spikes that can occur when swarms of devices respond to events in the physical world, and buffers these spikes to help isolate them from applications monitoring the data. [<a href=\"https:\/\/cloud.google.com\/architecture\/iot-overview\">src<\/a>]\r\n<\/p>\r\n\r\n<h5>\r\n    Firebase realtime database\r\n<\/h5>\r\n<p>\r\n    Firebase Realtime Database is a cloud-hosted NoSQL database that stores data as JSON. We use it to store the last value read from the sensors.\r\n<\/p>\r\n\r\n<h5>\r\n    Cloud BigQuery\r\n<\/h5>\r\n<p>\r\n    Cloud BigQuery enables standard SQL queries for interactive analysis of massively large datasets working in conjunction with Google Storage. \r\n<\/p>\r\n\r\n<h5>\r\n    Firebase Functions\r\n<\/h5>\r\n<p>\r\n    Firebase Functions lets you run backend code that responds to events in the Cloud.  We will have it responds to data published to a Pub\/Sub topic, or a request from DialogFlow to a HTTPS endpoint.\r\n<\/p>\r\n\r\n<h5>\r\n    Data Studio\r\n<\/h5>\r\n<p>\r\n    Data Studio can visualize data through configurable charts and tables. We are going to use it to visualize the historic data stored in BigQuery. \r\n<\/p>\r\n\r\n<h2>\r\n    Device to Cloud Pub\/Sub\r\n<\/h2>\r\n<p>\r\n    <div class=\"align-center\">\r\n        <figure>\r\n            <div class=\"flex-container tight\">\r\n                <a class=\"hide-anchor\" href=\"\/wp-content\/uploads\/block-diagram-ingest.svg\">\r\n                    <img width=\"500\" src=\"https:\/\/coert.vonk.one\/wp-content\/uploads\/block-diagram-ingest.svg\" alt=\"Block diagram: Device to Cloud Pub\/Sub\" class=\"alignnone size-full wp-image-24206\" \/>\r\n                <\/a>\r\n            <\/div>\r\n            <figcaption>\r\n                Block diagram: Device to Cloud Pub\/Sub\r\n            <\/figcaption>\r\n        <\/figure>\r\n    <\/div>\r\n<\/p>\r\n\r\n<h3>\r\n    Google Cloud\r\n<\/h3>\r\n<p>\r\n    We use Google Cloud to store and access the readings from our IoT device. To get started, head over <a href=\"https:\/\/accounts.google.com\/ServiceLogin?service=cloudconsole&#038;passive=1209600&#038;osid=1&#038;continue=https:\/\/console.cloud.google.com\/?ref%3Dhttps:\/\/coert.vonk.one&#038;followup=https:\/\/console.cloud.google.com\/?ref%3Dhttps:\/\/coert.vonk.one\">Cloud Console<\/a> and create a project and prepare it for Message Queuing Telemetry Transport (MQTT).  MQTT is a lightweight machine-to-machine publish\/subscribe protocol, often used where a small code footprint is required and\/or network bandwidth is at a premium. \r\n\r\n    <ol>\r\n        <li>\r\n            <ul class=\"breadcrumb\">\r\n                <li>\r\n                    <a class=\"nomark hide-anchor\" href=\"https:\/\/accounts.google.com\/ServiceLogin?service=cloudconsole&#038;passive=1209600&#038;osid=1&#038;continue=https:\/\/console.cloud.google.com\/?ref%3Dhttps:\/\/coert.vonk.one&#038;followup=https:\/\/console.cloud.google.com\/?ref%3Dhttps:\/\/coert.vonk.one\">\u2630<\/a>\r\n                <\/li>\r\n                <li>\r\n                    <a class=\"nomark hide-anchor\" href=\"#\">Top bar<\/a>\r\n                <\/li>\r\n                <li style=\"vertical-align: middle;\">\r\n                    <a class=\"nomark hide-anchor\" href=\"#\">\r\n                        <svg id=\"project_cache99\" style=\"padding-top:4px;\" height=\"16\" width=\"16\" viewBox=\"0 0 18 18\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" fit=\"\" preserveAspectRatio=\"xMidYMid meet\" focusable=\"false\"><path d=\"M10.557 11.99l-1.71-2.966 1.71-3.015h3.42l1.71 3.01-1.71 2.964h-3.42zM4.023 16l-1.71-2.966 1.71-3.015h3.42l1.71 3.01L7.443 16h-3.42zm0-8.016l-1.71-2.966 1.71-3.015h3.42l1.71 3.015-1.71 2.966h-3.42z\" fill-rule=\"evenodd\"><\/path><\/svg>\r\n                        Select a project\r\n                    <\/a>\r\n                <\/li>\r\n            <\/ul>\r\n            <ul>\r\n                <li>\r\n                    <span class=\"key-press-blue\">+<\/span> to create a project with a unique name (this post assumes the name &#8220;esp-nodejs-mqtt&#8221;)\r\n                <\/li>\r\n            <\/ul>\r\n        <\/li>\r\n        <li>\r\n            <ul class=\"breadcrumb\">\r\n                <li><a class=\"nomark hide-anchor\" href=\"https:\/\/accounts.google.com\/ServiceLogin?service=cloudconsole&#038;passive=1209600&#038;osid=1&#038;continue=https:\/\/console.cloud.google.com\/?ref%3Dhttps:\/\/coert.vonk.one&#038;followup=https:\/\/console.cloud.google.com\/?ref%3Dhttps:\/\/coert.vonk.one\">\u2630<\/a><\/li>\r\n                <li><a class=\"nomark hide-anchor\" href=\"#\"><svg id=\"BILLING_SECTION\" style=\"padding-top:4px;\" height=\"16\" width=\"16\" fill=\"currentColor\" fill-rule=\"evenodd\" height=\"100%\" viewBox=\"0 0 24 24\" width=\"100%\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" fit=\"\" preserveAspectRatio=\"xMidYMid meet\" focusable=\"false\"><path d=\"M3 7h9v2H3z\" opacity=\".4\"><\/path><path d=\"M12 7h9v2h-9z\" opacity=\".3\"><\/path><path d=\"M5 11h14v2H5z\" opacity=\".6\"><\/path><path d=\"M4 5a1 1 0 0 0-1 1v1h9V5H4z\"><\/path><path d=\"M20 5h-8v2h9V6a1 1 0 0 0-1-1z\" opacity=\".9\"><\/path><path d=\"M12 11V9H3v9a1 1 0 0 0 1 1l8-.004V13H5v-2h7zm-4 4v2H5v-2h3z\"><\/path><path d=\"M5 15h3v2H5z\" opacity=\".4\"><\/path><path d=\"M12 9v2h7v2h-7v5.996l8-.004a1 1 0 0 0 1-1V9h-9zm3 7h-1v-1h1v1zm3 0h-1v-1h1v1z\" opacity=\".9\"><\/path><path d=\"M14 15h1v1h-1zm3 0h1v1h-1z\" opacity=\".6\"><\/path><\/svg> Billing<\/a><\/li>\r\n            <\/ul>\r\n            <ul>\r\n                <li>Enable billing. Google Cloud has a generous free quota, but read the pricing and terms to ensure you are comfortable with them.<\/li>\r\n            <\/ul>\r\n        <\/li>\r\n        <li>\r\n            <ul class=\"breadcrumb\">\r\n                <li><a class=\"nomark hide-anchor\" href=\"https:\/\/accounts.google.com\/ServiceLogin?service=cloudconsole&#038;passive=1209600&#038;osid=1&#038;continue=https:\/\/console.cloud.google.com\/?ref%3Dhttps:\/\/coert.vonk.one&#038;followup=https:\/\/console.cloud.google.com\/?ref%3Dhttps:\/\/coert.vonk.one\">\u2630<\/a><\/li>\r\n                <li><a class=\"nomark hide-anchor\" href=\"#\"><svg id=\"API_SECTION\" style=\"padding-top:4px;\" height=\"16\" width=\"16\" fill=\"currentColor\" fill-rule=\"evenodd\" height=\"100%\" viewBox=\"0 0 24 24\" width=\"100%\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" fit=\"\" preserveAspectRatio=\"xMidYMid meet\" focusable=\"false\"><path d=\"M4 6c-1.125 0-2 .88-2 2v10h2v-5h2v5h2V8c0-1.12-.875-2-2-2H4zm0 5V8h2v3l-2 2v-2zm7-5c-1.125 0-2 .88-2 2v10h2v-5h2c1.125 0 2-.88 2-2V8c0-1.12-.875-2-2-2h-2zm0 5V8h2v3l-2 2v-2zm7-3h2l-2 2v6h-2v2h6v-2h-2V8h2V6h-6v2z\"><\/path><path d=\"M4 13v-2h2zm7 0v-2h2zm7-3V8h2z\" opacity=\".6\"><\/path><\/svg> APIs &#038; Services<\/a><\/li>\r\n                <li><a class=\"nomark hide-anchor\" href=\"#\"><svg id=\"\" height=\"100%\" viewBox=\"0 0 18 18\" fit=\"\" preserveAspectRatio=\"xMidYMid meet\" focusable=\"false\"><path d=\"M14 7V2.02h-2V7h-2V2.02H8V7H6V2.02H4.097V7H3v1h12V7zm0 3.02h-2V15h-2v-4.98H8V15H6v-4.98H4.097V15H3v1h12v-1h-1z\" fill-rule=\"evenodd\"><\/path><\/svg> Library<\/a><\/li>\r\n            <\/ul>\r\n            <ul>\r\n                <li>enable &#8220;<svg id=\"IOT_SECTION_cache834\" style=\"padding-top:4px;\" height=\"16\" width=\"16\" fill=\"none\" fill-rule=\"evenodd\" height=\"100%\" viewBox=\"0 0 32 32\" width=\"100%\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" fit=\"\" preserveAspectRatio=\"xMidYMid meet\" focusable=\"false\"><path d=\"M16.86 16.69h6.75v-4.52a1.82 1.82 0 1 1 1.68 0v4.51h.4a6.115 6.115 0 0 0 0-12.23v.02a6.1 6.1 0 0 0-1.95.32 8.34 8.34 0 0 0-15.13.1 6.11 6.11 0 1 0-2.24 11.8h.39v-4.52a1.82 1.82 0 1 1 1.68 0v4.52h6.73V9.62a1.82 1.82 0 1 1 1.68 0h.01v7.07z\" fill=\"#434343\"><\/path><path d=\"M8.45 21.41a3.2 3.2 0 0 1 2.45 3.14 3.3 3.3 0 1 1-4.14-3.19v-4.67h1.69v4.72zm-.85 4.75a1.62 1.62 0 0 0 1.61-1.61 1.61 1.61 0 1 0-1.61 1.61zm17.69-4.8a3.3 3.3 0 1 1-1.68 0V16.7h1.68v4.66zm-.84 4.8a1.62 1.62 0 0 0 1.61-1.61 1.61 1.61 0 1 0-1.61 1.61zm-7.59-.68l-.01-.01a3.3 3.3 0 1 1-1.68 0v-8.79h1.69v8.8zm-.86 4.8a1.61 1.61 0 1 0 0-3.22 1.61 1.61 0 0 0 0 3.22z\" fill=\"#757575\"><\/path><\/svg> Google Cloud IoT&#8221;<\/li>\r\n                <li>enable &#8220;<svg id=\"\" fill=\"none\" style=\"padding-top:4px;\" height=\"16\" width=\"16\" fill-rule=\"evenodd\" height=\"100%\" viewBox=\"0 0 32 32\" width=\"100%\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" fit=\"\" preserveAspectRatio=\"xMidYMid meet\" focusable=\"false\"><g transform=\"translate(1)\"><circle cx=\"26.146\" cy=\"9.936\" fill=\"#616161\" r=\"2.757\"><\/circle><circle cx=\"3.854\" cy=\"9.936\" fill=\"#616161\" r=\"2.757\"><\/circle><circle cx=\"15\" cy=\"29.242\" fill=\"#616161\" r=\"2.758\"><\/circle><path d=\"M20.475 18.062a5.717 5.717 0 0 1-1.28 2.2l6.315 3.647 1.273-2.21-6.308-3.64zM14 10.735a5.74 5.74 0 0 1 1-.092c.342 0 .675.035 1 .092V3.4h-2v7.335zM3.217 21.705L4.49 23.91l6.315-3.647a5.715 5.715 0 0 1-1.28-2.2l-6.308 3.64z\" fill=\"#424242\"><\/path><circle cx=\"15\" cy=\"16.372\" fill=\"#757575\" r=\"4.456\"><\/circle><circle cx=\"3.854\" cy=\"22.807\" fill=\"#757575\" r=\"3.5\"><\/circle><circle cx=\"26.146\" cy=\"22.807\" fill=\"#757575\" r=\"3.5\"><\/circle><circle cx=\"15\" cy=\"3.501\" fill=\"#757575\" r=\"3.501\"><\/circle><\/g><\/svg> Google Cloud Pub\/Sub&#8221;<\/li>\r\n            <\/ul>\r\n        <\/li>\r\n        <li>\r\n            <ul class=\"breadcrumb\">\r\n                <li><a class=\"nomark hide-anchor\" href=\"https:\/\/accounts.google.com\/ServiceLogin?service=cloudconsole&#038;passive=1209600&#038;osid=1&#038;continue=https:\/\/console.cloud.google.com\/?ref%3Dhttps:\/\/coert.vonk.one&#038;followup=https:\/\/console.cloud.google.com\/?ref%3Dhttps:\/\/coert.vonk.one\">\u2630<\/a><\/li>\r\n                <li><a class=\"nomark hide-anchor\" href=\"#\"><svg id=\"\" fill=\"none\" style=\"padding-top:4px;\" height=\"16\" width=\"16\" fill-rule=\"evenodd\" height=\"100%\" viewBox=\"0 0 32 32\" width=\"100%\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" fit=\"\" preserveAspectRatio=\"xMidYMid meet\" focusable=\"false\"><g transform=\"translate(1)\"><circle cx=\"26.146\" cy=\"9.936\" fill=\"#616161\" r=\"2.757\"><\/circle><circle cx=\"3.854\" cy=\"9.936\" fill=\"#616161\" r=\"2.757\"><\/circle><circle cx=\"15\" cy=\"29.242\" fill=\"#616161\" r=\"2.758\"><\/circle><path d=\"M20.475 18.062a5.717 5.717 0 0 1-1.28 2.2l6.315 3.647 1.273-2.21-6.308-3.64zM14 10.735a5.74 5.74 0 0 1 1-.092c.342 0 .675.035 1 .092V3.4h-2v7.335zM3.217 21.705L4.49 23.91l6.315-3.647a5.715 5.715 0 0 1-1.28-2.2l-6.308 3.64z\" fill=\"#424242\"><\/path><circle cx=\"15\" cy=\"16.372\" fill=\"#757575\" r=\"4.456\"><\/circle><circle cx=\"3.854\" cy=\"22.807\" fill=\"#757575\" r=\"3.5\"><\/circle><circle cx=\"26.146\" cy=\"22.807\" fill=\"#757575\" r=\"3.5\"><\/circle><circle cx=\"15\" cy=\"3.501\" fill=\"#757575\" r=\"3.501\"><\/circle><\/g><\/svg> Pub\/Sub<\/a><\/li>\r\n                <li><a class=\"nomark hide-anchor\" href=\"#\">Topics<\/a><\/li>\r\n                <li><a class=\"nomark hide-anchor\" href=\"#\">Create a topic<\/a><\/li>\r\n            <\/ul>\r\n            Connect your services with reliable, many-to-many, asynchronous messaging hosted on Google&#8217;s infrastructure.\r\n            <ul>      \r\n                <li>Name: <code>mqtt-topic<\/code><\/li>\r\n            <\/ul>\r\n        <\/li>\r\n        <li>\r\n            <ul class=\"breadcrumb\">\r\n                <li><a class=\"nomark hide-anchor\" href=\"https:\/\/accounts.google.com\/ServiceLogin?service=cloudconsole&#038;passive=1209600&#038;osid=1&#038;continue=https:\/\/console.cloud.google.com\/?ref%3Dhttps:\/\/coert.vonk.one&#038;followup=https:\/\/console.cloud.google.com\/?ref%3Dhttps:\/\/coert.vonk.one\">\u2630<\/a><\/li>\r\n                <li><a class=\"nomark hide-anchor\" href=\"#\"><svg id=\"IOT_SECTION_cache834\" style=\"padding-top:4px;\" height=\"16\" width=\"16\" fill=\"none\" fill-rule=\"evenodd\" height=\"100%\" viewBox=\"0 0 32 32\" width=\"100%\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" fit=\"\" preserveAspectRatio=\"xMidYMid meet\" focusable=\"false\"><path d=\"M16.86 16.69h6.75v-4.52a1.82 1.82 0 1 1 1.68 0v4.51h.4a6.115 6.115 0 0 0 0-12.23v.02a6.1 6.1 0 0 0-1.95.32 8.34 8.34 0 0 0-15.13.1 6.11 6.11 0 1 0-2.24 11.8h.39v-4.52a1.82 1.82 0 1 1 1.68 0v4.52h6.73V9.62a1.82 1.82 0 1 1 1.68 0h.01v7.07z\" fill=\"#434343\"><\/path><path d=\"M8.45 21.41a3.2 3.2 0 0 1 2.45 3.14 3.3 3.3 0 1 1-4.14-3.19v-4.67h1.69v4.72zm-.85 4.75a1.62 1.62 0 0 0 1.61-1.61 1.61 1.61 0 1 0-1.61 1.61zm17.69-4.8a3.3 3.3 0 1 1-1.68 0V16.7h1.68v4.66zm-.84 4.8a1.62 1.62 0 0 0 1.61-1.61 1.61 1.61 0 1 0-1.61 1.61zm-7.59-.68l-.01-.01a3.3 3.3 0 1 1-1.68 0v-8.79h1.69v8.8zm-.86 4.8a1.61 1.61 0 1 0 0-3.22 1.61 1.61 0 0 0 0 3.22z\" fill=\"#757575\"><\/path><\/svg> IoT Core<\/a><\/li>\r\n                <li><a class=\"nomark hide-anchor\" href=\"#\">Create device registry<\/a><\/li>\r\n            <\/ul>\r\n            A device registry allows you to group and set properties that they all share, such as connection protocol, data storage location, and CLoud Pub\/Sub topics.\r\n            <ul>\r\n                <li>Registry ID: <code>mqtt-registry<\/code><\/li>\r\n                <li>Cloud region: <code>us-central1<\/code> (whatever is closer to you)<\/li>\r\n                <li>Protocol: <code>MQTT, HTTP<\/code><\/li>\r\n                <li>Default telemetry topic: <code>mqtt-topic<\/code><\/li>\r\n            <\/ul>\r\n        <\/li>\r\n    <\/ol>\r\n<\/p>\r\n<p>\r\n    We will add the device and its public key in the next section.\r\n<\/p>\r\n\r\n<h3>\r\n    The &#8220;thing&#8221;\r\n<\/h3>\r\n<p>\r\n    Our &#8220;thing&#8221; will be an Espressif ESP32 board with an integrated USBSerial, such as the Adafruit HUZZAH32.  No particular reason, besides that it is cheap and has build-in WiFi.  A temperature and humidity sensor is connected to <code>GPIO21<\/code>.  If you use an ESP8266, connect the sensor to <code>GPIO4<\/code>.\r\n<\/p>\r\n<p>\r\n    On the ESP32, we use a off-the-shelf firmware that can be programmed using JavaScript. The firmware, called Mongoose OS, comes with a library to interface with Google IoT Core. [<a href=\"https:\/\/github.com\/cesanta\/mongoose-os\">github<\/a>, <a href=\"https:\/\/github.com\/mongoose-os-libs\/gcp\">github<\/a>].\r\n<\/p>\r\n\r\n<h4>\r\n    Tools\r\n<\/h4>\r\n<p>\r\n    The command line tool <code>mos<\/code> generates custom firmware and uploads it to the ESP32. The tool also gives easy access to the serial debug port and SPIFFS file system. For integration with Cloud IoT, it relies on Google&#8217;s <code>gcloud<\/code> command line tool.\r\n<\/p>\r\n\r\n<h5>\r\n    <code style=\"background: inherit;\">gcloud<\/code>\r\n<\/h5>\r\n<p>\r\n    We will start with installing the Google Cloud tool and linking it to our project.\r\n    <ol>\r\n        <li>Open a command terminal, create a <em>project directory<\/em> and make that the active directory.<\/li>\r\n        <li>Install the <code>gcloud<\/code> command line tool as described in <a href=\"https:\/\/cloud.google.com\/sdk\/docs\/\">Cloud SDK<\/a>.\r\n        <ul>\r\n            <li>Choose to include all components (incl. Beta components).<\/li>\r\n            <li>Accept all post-install options. Once it executes <code>gcloud init<\/code>, choose to \r\n            <ul>\r\n                <li>login (to Google), and follow the directions,<\/li>\r\n                <li>pick your cloud project (for us that was &#8220;esp-nodejs-mqtt&#8221;).<\/li>\r\n                <li>It should finish with &#8220;Your Google Cloud SDK is configured and ready to use&#8221;<\/li>\r\n            <\/ul>\r\n            <\/li>\r\n        <\/ul>\r\n        <li>Give Cloud IoT access your project\r\n        <pre class=\"brush: powershell; gutter: true; title: ; toolbar: false; notranslate\" title=\"\">gcloud projects add-iam-policy-binding esp-nodejs-mqtt `\r\n        --member=serviceAccount:cloud-iot@system.gserviceaccount.com `\r\n        --role=roles\/pubsub.publisher<\/pre>\r\n        Remember to use your own project id (see <code>cloud projects list<\/code>).<\/li>\r\n    <\/ol>\r\n<\/p>\r\n\r\n<h5 id=\"install-mongooseos\">\r\n    <code style=\"background: inherit;\">mos<\/code>\r\n<\/h5>\r\n<p>\r\n    Install the Mongoose OS tool and install the Cloud IoT&#8217;s CA certificate\r\n    <ol>\r\n        <li>Open a command terminal, and make your project directory the current directory.<\/li>\r\n        <li>Start with some boilerplate code (install <code>git<\/code> if you haven&#8217;t done so already)\r\n        <pre class=\"brush: powershell; gutter: true; title: ; toolbar: false; notranslate\" title=\"\">git clone https:\/\/github.com\/mongoose-os-apps\/empty firmware<\/pre><\/li>\r\n        <li>Install the <code>mos<\/code> tool in the <code>firmware<\/code> directory according to its <a href=\"https:\/\/mongoose-os.com\/software.html\">instructions<\/a>.<\/li>\r\n        <li>Downgrade to version 1.22 because this seems to be the last stable version \r\n        <pre class=\"brush: powershell; gutter: true; title: ; toolbar: false; notranslate\" title=\"\">firmware\\mos update 1.22<\/pre><\/li>\r\n        <li>Connect the ESP32 to your computer using USB.<\/li>\r\n        <li>Make the <code>firmware<\/code> you current directory.\r\n        <li>Retrieve Google Cloud&#8217;s CA certificate using a *nix system with <code>openssl<\/code> installed\r\n        <pre class=\"brush: powershell; gutter: true; title: ; toolbar: false; notranslate\" title=\"\">echo -n | openssl s_client -showcerts -connect mqtt.googleapis.com:8883 | \\\r\n        sed -ne '\/-BEGIN CERTIFICATE-\/,\/-END CERTIFICATE-\/p' > ca.pem<\/pre>\r\n        Copy this <code>ca.pem<\/code> to <code>firmware\\fs\\ca.pem<\/code><\/li>\r\n    <\/ol>\r\n<\/p>\r\n\r\n<h4>\r\n    Program the device\r\n<\/h4>\r\n<p>\r\n    With Cloud IoT setup, it is time to tell the device what to do.  For this tutorial, the device will measure the temperature and humidity every 5 seconds.  Every 15 minutes it will publish the readings to Cloud IoT as topic <code>\/devices\/DEVICENAME\/events\/<\/code>.\r\n    <ol>\r\n        <li>\r\n            Update the build description <code>firmware\\mos.yml<\/code> with the apps&#8217; configuration and libraries\r\n\r\n            <pre class=\"brush: yaml; gutter: true; light: false; title: ; toolbar: false; notranslate\" title=\"\">author: Alvaro Viebrantz, modified by Coert Vonk\r\ndescription: esp-nodejs-iot firmware\r\nversion: 1.0\r\n\r\nlibs_version: ${mos.version}\r\nmodules_version: ${mos.version}\r\nmongoose_os_version: ${mos.version}\r\n\r\n# List of files\/directories with C sources. No slashes at the end of dir names\r\nsources:\r\n    - src\r\n\r\n# Files from these dirs will be copied to the device filesystem\r\nfilesystem:\r\n    - fs\r\n\r\n# Custom configuration entries, settable via \"device configuration\"\r\nconfig_schema:\r\n    - [\"i2c.enable\", true]\r\n    - [\"app\", \"o\", { title: \"App custom settings\"}]\r\n    - [\"app.dht\", \"i\", 21, { title: \"DHT pin\"}]\r\n\r\n# List of libraries used by this app, in order of initialisation\r\nlibs:\r\n# use fs\\ca.pem instead of https:\/\/github.com\/mongoose-os-libs\/ca-bundle\r\n# - origin: https:\/\/github.com\/mongoose-os-libs\/ca-bundle\r\n    - origin: https:\/\/github.com\/mongoose-os-libs\/rpc-service-config\r\n    - origin: https:\/\/github.com\/mongoose-os-libs\/rpc-service-fs\r\n    - origin: https:\/\/github.com\/mongoose-os-libs\/rpc-uart\r\n    - origin: https:\/\/github.com\/mongoose-os-libs\/wifi\r\n# libs for the current app\r\n    - origin: https:\/\/github.com\/mongoose-os-libs\/mqtt\r\n    - origin: https:\/\/github.com\/mongoose-os-libs\/i2c\r\n    - origin: https:\/\/github.com\/mongoose-os-libs\/gcp\r\n    - origin: https:\/\/github.com\/mongoose-os-libs\/mjs\r\n    - origin: https:\/\/github.com\/mongoose-os-libs\/dht\r\n\r\n# Used by the mos tool to catch mos binaries incompatible with this file format\r\nmanifest_version: 2017-05-18<\/pre>\r\n        <\/li>\r\n        <li>\r\n            When using the ESP8266, add a device-type specific build description <code>firmware\\mos_esp8266.yml<\/code> to change the DHT pin to <code>GPIO4<\/code>\r\n\r\n            <pre class=\"brush: yaml; gutter: true; light: false; title: ; toolbar: false; notranslate\" title=\"\"># ESP8266 specific configuration entries\r\nconfig_schema:\r\n    - [\"app.dht\", \"i\", 4, { title: \"DHT pin\"}]\r\n    <\/pre>\r\n        <\/li>\r\n        <li>\r\n            Create a JavaScript program <code>firmware\\fs\\init.js<\/code> to read the sensor and periodically publish it to Cloud IoT. The program assigns the sensor pin based on the <code>app.dht<\/code> property in the <code>yml<\/code> build description.\r\n\r\n            <pre class=\"brush: jscript; gutter: true; light: false; title: ; toolbar: false; notranslate\" title=\"\">load('api_config.js');\r\nload('api_mqtt.js');\r\nload('api_timer.js');\r\nload('api_dht.js');\r\nload('api_config.js');\r\nload('api_gpio.js');\r\nload('api_mqtt.js');\r\nload('api_net.js');\r\nload('api_sys.js');\r\n\r\nlet appName = 'init.js             ';\r\nlet deviceName = Cfg.get('device.id');\r\n\r\n\/\/ The MQTT topic name is required to be in the format below. The topic name must end\r\n\/\/ in 'state' to publish state and 'events' to publish telemetry. Note that this is\r\n\/\/ not the same as the device registry's Cloud Pub\/Sub topic.\r\nlet topic = '\/devices\/' + deviceName + '\/events';\r\nprint(appName, 'Topic:', topic);\r\n\r\nlet isConnected = false;\r\nlet dhtPin = Cfg.get('app.dht');\r\nlet dht = DHT.create(dhtPin, DHT.DHT11);\r\n\r\nfunction getInfo() {\r\n    return JSON.stringify({\r\n        total_ram: Sys.total_ram() \/ 1024,\r\n        free_ram: Sys.free_ram() \/ 1024,\r\n        temp: dht.getTemp(),\r\n        hum: dht.getHumidity()\r\n    });\r\n};\r\n\r\nfunction publishData() {\r\n    if (MQTT.pub(topic, getInfo())) {\r\n        print(appName, 'Published');\r\n    }\r\n}\r\n\r\nTimer.set(\r\n    15 * 60 * 1000, true,\r\n    function() {\r\n        if (isConnected) {\r\n            print(appName, '5 minute timer, CONNECTED > PUBLISH');\r\n            publishData();\r\n        }\r\n    }, null\r\n);\r\n\r\nTimer.set(\r\n    5 * 1000, true,\r\n    function() {\r\n        print(appName, 'Info:', getInfo());\r\n    }, null\r\n);\r\n\r\nMQTT.setEventHandler(function(conn, ev, data) {\r\n    if (ev !== 0) {\r\n        let evs = '?';\r\n        if (ev === MQTT.EV_CONNACK) {\r\n            evs = 'CONNACK';   \/\/ Connection to broker has been established\r\n        } else if (ev === MQTT.EV_PUBLISH) {\r\n            evs = 'PUBLISH';   \/\/ msg published to topics we are subscribed to\r\n        } else if (ev === MQTT.EV_PUBACK) {\r\n            evs = 'PUBACK';    \/\/ ACK for publishing of a message with QoS>0\r\n        } else if (ev === MQTT.EV_SUBACK) {\r\n            evs = 'SUBACK';    \/\/ ACK for a subscribe request\r\n        } else if (ev === MQTT.EV_UNSUBACK) {\r\n            evs = 'UNSUBACK';  \/\/ ACK for an unsubscribe request\r\n        } else if (ev === MQTT.EV_CLOSE) {\r\n            evs = 'CLOSE';     \/\/ connection to broker was closed\r\n        }\r\n        print(appName, 'MQTT event:', evs, ev);\r\n        if (ev === MQTT.EV_CONNACK) {\r\n            print(appName, 'MQTT CONNACK > PUBLISHING');\r\n            isConnected = true;\r\n            publishData();\r\n        }\r\n    }\r\n}, null);<\/pre>\r\n        <\/li>\r\n        <li>\r\n            Create a binary and file system for the device\r\n\r\n            <pre class=\"brush: powershell; gutter: true; light: false; title: ; toolbar: false; notranslate\" title=\"\">.\\mos build --arch esp32\r\n.\\mos flash<\/pre>\r\n        <\/li>\r\n    <\/ol>\r\n<\/p>\r\n\r\n<h3>\r\n    Deploy\r\n<\/h3>\r\n<\/p>\r\n<p>\r\n    Register with Cloud IoT and configure WiFi\r\n\r\n    <ol>\r\n        <li>Register the device with Cloud IoT. This single command will\r\n        <ul>\r\n            <li>use the device id to generate a key pair,<\/li>\r\n            <li>upload the private key to the device,<\/li>\r\n            <li>add <code>gcp<\/code> and <code>mqtt<\/code> configuration to the <code>conf9.json<\/code> file on the device,<\/li>\r\n            <li>(re)create the device with its public key to Cloud IoT.<\/li>\r\n        <\/ul>\r\n        <pre class=\"brush: powershell; gutter: true; light: false; title: ; toolbar: false; notranslate\" title=\"\">.\\mos gcp-iot-setup --gcp-project esp-nodejs-mqtt --gcp-region us-central1 ^\r\n        --gcp-registry mqtt-registry<\/pre>\r\n        Once more, remember to use your own project id and geographic region.  If successful, it will show the JSON <code>gcp<\/code> and <code>mqtt<\/code> configuration.  If the command hangs, make sure that <code>GPIO12<\/code> is not pulled down.    \r\n        <\/li>\r\n        <li>Add the WiFi credentials to the configuration <code>conf9.json<\/code> file on the device \r\n        <pre class=\"brush: powershell; gutter: true; light: false; title: ; toolbar: false; notranslate\" title=\"\">.\\mos wifi \"yourWiFiSSID\" \"yourWiFiPasswd\"<\/pre><\/li>\r\n    <\/ol>\r\n<\/p>\r\n\r\n<h3>\r\n    Expected results and debugging\r\n<\/h3>\r\n<p>\r\n    The device should be connecting to Cloud IoT as evident from the device&#8217;s debug trace and current value pulled from Cloud IoT\r\n    <ol>\r\n        <li>\r\n        <ul class=\"breadcrumb\">\r\n            <li><a class=\"nomark hide-anchor\" href=\"https:\/\/accounts.google.com\/ServiceLogin?service=cloudconsole&#038;passive=1209600&#038;osid=1&#038;continue=https:\/\/console.cloud.google.com\/?ref%3Dhttps:\/\/coert.vonk.one&#038;followup=https:\/\/console.cloud.google.com\/?ref%3Dhttps:\/\/coert.vonk.one\">\u2630<\/a><\/li>\r\n            <li><a class=\"nomark hide-anchor\" href=\"#\">IoT Core<\/a><\/li>\r\n            <li><a class=\"nomark hide-anchor\" href=\"#\">your registry id<\/a><\/li>\r\n            <li><a class=\"nomark hide-anchor\" href=\"#\">your device id<\/a><\/li>\r\n        <\/ul>\r\n        This should show when the last telemetry event was received, and the device&#8217;s ES256 public key.\r\n\r\n        <li>Show the debug output of the device\r\n        <pre class=\"brush: powershell; gutter: true; light: false; title: ; toolbar: false; notranslate\" title=\"\">.\\mos console<\/pre><\/li>\r\n    <ul>\r\n<\/p>\r\n<p>\r\n    If things go well you will see debug messages from the device such as\r\n\r\n    <div class=\"align-center\">\r\n        <figure>\r\n            <div class=\"flex-container tight\">\r\n                <pre class=\"brush: plain; gutter: true; light: true; title: ; toolbar: false; notranslate\" title=\"\">esp32_mgos_init      firmware 1.0 (20180309-003629\/???)\r\nmgos_i2c_create      I2C GPIO init ok (SDA: 32, SCL: 33)\r\ninit.js              Topic:  \/devices\/esp32_F00F00\/events \r\ninit.js              Net event: CONNECTING 1 \r\ninit.js              Net event: CONNECTED 2 \r\ninit.js              Net event: GOT_IP 3 \r\nmgos_mqtt_global_con MQTT connecting to mqtt.googleapis.com:8883\r\nmgos_sntp_query      SNTP query to time.google.com\r\nmgos_mqtt_ev         MQTT TCP connect ok (0)\r\nmgos_sntp_ev         SNTP reply from 216.239.35.4: time 1520555855.896951, loc...\r\ninit.js              Info: {\"hum\":55,\"temp\":21,\"free_ram\":201.261719,\"total_ra... \r\nmgos_mqtt_ev         MQTT CONNACK 0\r\ninit.js              MQTT event: CONNACK 202 \r\ninit.js              MQTT CONNACK > PUBLISHING \r\ninit.js              Published \r\ninit.js              Info: {\"hum\":48,\"temp\":21,\"free_ram\":202.527344,\"total_ra... \r\ninit.js              Info: {\"hum\":57,\"temp\":21,\"free_ram\":202.527344,\"total_ra,..<\/pre>\r\n           <\/div>\r\n            <figcaption>\r\n                Debug messages from the ESP32 device\r\n            <\/figcaption>\r\n        <\/figure>\r\n    <\/div>\r\n<\/p>\r\n<p>\r\n    If things don&#8217;t go so smooth, you&#8217;re best starting point is using the MongooseOS web interface (<code>.\\mos ui<\/code>). A common cause of errors is uploading the firmware after configuring the device causing the configuration to be overwritten. Net connection errors may be the effect of missing or incorrect WiFi credentials in <code>conf9.json<\/code> on the device.  If you encounter MQTT <code>CONNACK 4<\/code> messages, check the <code>ca.pem<\/code> certificate.  This should match the certificate pulled using <code>openssl<\/code> <a href=\"#install-mongooseos\">earlier<\/a>.  Also try switching to version 1.22 of the <code>mos<\/code> tool if aren&#8217;t using this already.  <code>CONNACK 5<\/code> on the other hand, hints at using the wrong registry or project name.\r\n<\/p>\r\n\r\n<h2>\r\n    Cloud Pub\/Sub to BigQuery\r\n<\/h2>\r\n<p>\r\n    We use Cloud BigQuery to store the device data. Google BigQuery is a web service that lets you do interactive analysis of massive datasets\u2014up to billions of rows. \r\n\r\n    <div class=\"align-center\">\r\n        <figure>\r\n            <div class=\"flex-container tight\">\r\n                <a class=\"hide-anchor broken_link\" href=\"\/wp-content\/uploadsblock-diagram-ingest.svg.svg\">\r\n                    <img width=\"500\" src=\"https:\/\/coert.vonk.one\/wp-content\/uploads\/block-diagram-ingest.svg\" alt=\"Block diagram: Cloud Pub\/Sub to BigQuery and Firebase Store\" class=\"alignnone size-full wp-image-24206\" \/>\r\n                <\/a>\r\n            <\/div>\r\n            <figcaption>Block diagram: Cloud Pub\/Sub to BigQuery and Firebase Store<\/figcaption>\r\n        <\/figure>\r\n    <\/div>\r\n<\/p>\r\n\r\n<h3>\r\n    BigQuery storage\r\n<\/h3>\r\n<p>\r\n    To get started, head over to <a href=\"https:\/\/accounts.google.com\/ServiceLogin?service=bigquery&#038;passive=1209600&#038;continue=https:\/\/bigquery.cloud.google.com\/&#038;followup=https:\/\/bigquery.cloud.google.com\/\">BigQuery Console<\/a> and create a dataset and table.\r\n\r\n    <ol>\r\n        <li>\r\n            <ul class=\"breadcrumb\">\r\n                <li><a class=\"nomark hide-anchor\" href=\"https:\/\/accounts.google.com\/ServiceLogin?service=cloudconsole&#038;passive=1209600&#038;osid=1&#038;continue=https:\/\/console.cloud.google.com\/?ref%3Dhttps:\/\/coert.vonk.one&#038;followup=https:\/\/console.cloud.google.com\/?ref%3Dhttps:\/\/coert.vonk.one\">\u2630<\/a><\/li>\r\n                <li style=\"vertical-align: middle;\"><a class=\"nomark hide-anchor\" href=\"#\"><svg id=\"BIGQUERY_SECTION\" style=\"padding-top:4px;\" height=\"16\" width=\"16\" fill=\"currentColor\" fill-rule=\"evenodd\" height=\"100%\" viewBox=\"0 0 24 24\" width=\"100%\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" fit=\"\" preserveAspectRatio=\"xMidYMid meet\" focusable=\"false\"><path d=\"M7 11v1.922c.25.87 1.176 1.48 2 1.85V11H7z\" opacity=\".6\"><\/path><path d=\"M10 9v5.933c.34.04.688.067 1.045.067.326 0 .643-.023.955-.058V9h-2z\"><\/path><path d=\"M13.007 12v2.7c.836-.373 1.618-.825 2-1.85V12h-2zm7.883 7.072l-3.19-3.188a.363.363 0 0 0-.304-.095c-.457.61-1 1.15-1.61 1.602a.37.37 0 0 0 .097.305l3.187 3.186a.38.38 0 0 0 .537 0l1.28-1.28a.38.38 0 0 0 0-.538z\" opacity=\".6\"><\/path><path d=\"M11 3a8 8 0 1 0 0 16 8 8 0 0 0 0-16m0 14a6 6 0 1 1 0-12 6 6 0 0 1 0 12\"><\/path><\/svg> BigQuery<\/a><\/li>\r\n                <li><a class=\"nomark hide-anchor\" href=\"#\">project name <span style=\"background-color: inherit; font-size: 11px;\" class=\"key-press\"><svg width=\"12\" height=\"10\" fill=\"currentColor\" fill-rule=\"evenodd\" viewBox=\"0 0 30.281 29.469\" height=\"100%\" width=\"100%\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" fit=\"\" preserveAspectRatio=\"xMidYMid meet\" focusable=\"false\"><polygon fill=\"#000000\" points=\"26.506,14.786 15.167,23.29 3.829,14.786 \"\/><\/svg><\/span><\/a><\/li>\r\n                <li><a class=\"nomark hide-anchor\" href=\"#\">Create new dataset<\/a><\/li>\r\n            <\/ul>\r\n            <ul>\r\n                <li>Dataset ID: <code>esp_nodejs_mqtt<\/code> (your project name)<\/li>\r\n                <li>Data location: <code>US<\/code> (whatever is closer)<\/li>\r\n                <li>Data expiration: <code>Never<\/code><\/li>\r\n            <\/ul>\r\n        <\/li>\r\n        <li>\r\n            <ul class=\"breadcrumb\">\r\n                <li><a class=\"nomark hide-anchor\" href=\"https:\/\/accounts.google.com\/ServiceLogin?service=cloudconsole&#038;passive=1209600&#038;osid=1&#038;continue=https:\/\/console.cloud.google.com\/?ref%3Dhttps:\/\/coert.vonk.one&#038;followup=https:\/\/console.cloud.google.com\/?ref%3Dhttps:\/\/coert.vonk.one\">\u2630<\/a><\/li>\r\n                <li style=\"vertical-align: middle;\"><a class=\"nomark hide-anchor\" href=\"#\"><svg id=\"BIGQUERY_SECTION\" style=\"padding-top:4px;\" height=\"16\" width=\"16\" fill=\"currentColor\" fill-rule=\"evenodd\" height=\"100%\" viewBox=\"0 0 24 24\" width=\"100%\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" fit=\"\" preserveAspectRatio=\"xMidYMid meet\" focusable=\"false\"><path d=\"M7 11v1.922c.25.87 1.176 1.48 2 1.85V11H7z\" opacity=\".6\"><\/path><path d=\"M10 9v5.933c.34.04.688.067 1.045.067.326 0 .643-.023.955-.058V9h-2z\"><\/path><path d=\"M13.007 12v2.7c.836-.373 1.618-.825 2-1.85V12h-2zm7.883 7.072l-3.19-3.188a.363.363 0 0 0-.304-.095c-.457.61-1 1.15-1.61 1.602a.37.37 0 0 0 .097.305l3.187 3.186a.38.38 0 0 0 .537 0l1.28-1.28a.38.38 0 0 0 0-.538z\" opacity=\".6\"><\/path><path d=\"M11 3a8 8 0 1 0 0 16 8 8 0 0 0 0-16m0 14a6 6 0 1 1 0-12 6 6 0 0 1 0 12\"><\/path><\/svg> BigQuery<\/a><\/li>\r\n                <li><a class=\"nomark hide-anchor\" href=\"#\">project name <span style=\"background-color: inherit; font-size: 11px; line-height: 12px;\" class=\"key-press\">+<\/span><\/a><\/li>\r\n            <\/ul>\r\n            <ul>\r\n                <li>Source Data: <code>Create empty table<\/code><\/li>\r\n                <li>Destination table name: esp_node_js.<code>raw_data<\/code><\/li>\r\n                <li>Schema fields:\r\n                <pre class=\"brush: plain; gutter: true; light: true; title: ; toolbar: false; notranslate\" title=\"\">deviceId  STRING     REQUIRED\r\n    timestamp TIMESTAMP  REQUIRED\r\n    temp      FLOAT      REQUIRED\r\n    humidity  FLOAT      REQUIRED<\/pre>\r\n                <\/li>\r\n                <li>Partitioning type = <code>Day<\/code><\/li>\r\n            <ul>\r\n        <\/li>\r\n    <\/ol>\r\n<\/p>\r\n\r\n<h3>\r\n    Firebase functions\r\n<\/h3>\r\n<p>\r\n    Firebase provides easy access to Google Cloud services intended for mobile or web. \r\n<\/p>\r\n<p>\r\n    Link Firebase to your Cloud project using the <a href=\"https:\/\/accounts.google.com\/ServiceLogin?passive=1209600&#038;osid=1&#038;continue=https:\/\/console.firebase.google.com\/&#038;followup=https:\/\/console.firebase.google.com\/\">Firebase Console<\/a>\r\n\r\n    <ol>\r\n        <li>\r\n            <ul class=\"breadcrumb\">\r\n                <li><a class=\"nomark hide-anchor\" href=\"https:\/\/accounts.google.com\/ServiceLogin?passive=1209600&#038;osid=1&#038;continue=https:\/\/console.firebase.google.com\/&#038;followup=https:\/\/console.firebase.google.com\/\"><svg version=\"1.1\" id=\"Layer_1\" tyle=\"padding-top:4px;\" height=\"16\" width=\"16\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" xmlns:xlink=\"http:\/\/www.w3.org\/1999\/xlink\" x=\"0px\" y=\"0px\"\t width=\"13.659px\" height=\"18.829px\" viewBox=\"0 0 13.659 18.829\" enable-background=\"new 0 0 13.659 18.829\" xml:space=\"preserve\"><g id=\"Firebase\"><path fill=\"#FEC24C\" d=\"M0,15.198l0.113-0.159l5.392-10.23l0.012-0.109L3.141,0.234C2.94-0.14,2.38-0.045,2.314,0.373L0,15.198z\"\/><g><path id=\"a\" fill=\"#FAA71C\" d=\"M0.066,15.076l0.086-0.167L5.487,4.785L3.116,0.301C2.919-0.07,2.42,0.025,2.355,0.44L0.066,15.076\t\t\tz\"\/><\/g><path fill=\"#F3BD63\" d=\"M7.249,8.077l1.77-1.813L7.248,2.884c-0.168-0.319-0.638-0.321-0.804,0L5.498,4.688v0.153L7.249,8.077\t\tL7.249,8.077z\"\/><g><path id=\"c\" fill=\"#FAA51A\" d=\"M7.218,8l1.721-1.763L7.218,2.961c-0.163-0.311-0.56-0.343-0.724-0.032L5.546,4.762L5.517,4.855\t\t\tL7.218,8z\"\/><\/g><path fill=\"#F58220\" d=\"M0,15.198l0.05-0.053l0.188-0.076l6.899-6.874l0.088-0.238l-1.721-3.28L0,15.198z\"\/><path fill=\"#FCE069\" d=\"M7.47,18.665l6.245-3.482L11.933,4.2c-0.057-0.343-0.479-0.479-0.725-0.231L0,15.198l6.208,3.467\t\tC6.601,18.883,7.078,18.883,7.47,18.665\"\/><path fill=\"#FCCB3F\" d=\"M13.657,15.153l-1.769-10.9c-0.054-0.34-0.405-0.481-0.649-0.235L0.068,15.177l6.14,3.432\t\tc0.39,0.216,0.863,0.216,1.253,0l6.198-3.456H13.657z\"\/><path fill=\"#EEAC38\" d=\"M7.47,18.56c-0.392,0.222-0.869,0.222-1.262,0l-6.159-3.415L0,15.198l6.208,3.467\t\tc0.393,0.219,0.87,0.219,1.262,0l6.245-3.482l-0.016-0.095L7.47,18.56L7.47,18.56z\"\/><\/g><\/svg><\/a><\/li>\r\n                <li style=\"vertical-align: middle;\"><a class=\"nomark hide-anchor\" href=\"#\"><span style=\"background-color: inherit; font-size: 11px; line-height: 12px;\" class=\"key-press\">+<\/span> Add project<\/a><\/li>\r\n                <li style=\"vertical-align: middle;\"><a class=\"nomark hide-anchor\" href=\"#\"><span style=\"background-color: inherit; font-size: 11px;\" class=\"key-press\"><svg width=\"12\" height=\"10\" fill=\"currentColor\" fill-rule=\"evenodd\" viewBox=\"0 0 30.281 29.469\" height=\"100%\" width=\"100%\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" fit=\"\" preserveAspectRatio=\"xMidYMid meet\" focusable=\"false\"><polygon fill=\"#000000\" points=\"26.506,14.786 15.167,23.29 3.829,14.786 \"\/><\/svg><\/span>\u00a0\u00a0<\/a><\/li>\r\n            <\/ul>\r\n            <ul>\r\n                <li>Project name: <code>esp-node-js-mqtt<\/code> (your project name from the pull down list)<\/li>\r\n                <li><span style=\"background-color: inherit; font-size: 11px; line-height: 12px;\" class=\"key-press\">Add Firebase<\/span> <span style=\"background-color: inherit; font-size: 11px; line-height: 12px;\" class=\"key-press\">Confirm plan<\/span><\/li>\r\n            <\/ul>\r\n        <\/li>\r\n    <\/ol>\r\n<\/p>\r\n\r\n<h4>\r\n    <code style=\"background: inherit;\">node<\/code> tool\r\n<\/h4>\r\n<p>\r\n    Start with installing Node JavaScript (NodeJS).\r\n    <ol>\r\n        <li>\r\n            Open a command terminal and make your project directory the current directory.  Create a subdirectory (e.g. <code>firebase<\/code> and make that the current directory.\r\n            <ul>\r\n                <li>Firebase doesn&#8217;t tolerate spaces in the file path.  On Windows, you can work around this creating a symbolic link (<code>mklink \/d<\/code>) or map a virtual drive to a UNC path (<code>net use<\/code>).<\/li>\r\n            <\/ul>\r\n        <\/li>\r\n        <li>\r\n            Install the LTS version of NodeJS from <a href=\"https:\/\/nodejs.org\/en\/download\/\">nodejs.org<\/a> with the default options.\r\n        <\/li>\r\n        <li>\r\n            Update the NodeJS package manager from a command terminal\r\n\r\n            <pre class=\"brush: powershell; gutter: true; light: false; title: ; toolbar: false; notranslate\" title=\"\">npm i npm<\/pre>\r\n        <\/li>\r\n    <\/ol>\r\n<\/p>\r\n\r\n<h4>\r\n    <code style=\"background: inherit;\">firebase<\/code> tool\r\n<\/h4>\r\n<p>\r\n    <ol>\r\n        <li>\r\n            Install the NodeJS package &#8220;firebase&#8221;.  We install the bleeding edge to work around <a href=\"https:\/\/github.com\/firebase\/firebase-tools\/issues\/610\">issue #610<\/a>. The <code>-g<\/code> parameter causes the modules to be installed globally (in <code>%APPDATA%\\npm<\/code>).\r\n\r\n            <pre class=\"brush: plain; gutter: true; light: false; title: ; toolbar: false; notranslate\" title=\"\">npm install -g git:\/\/github.com\/firebase\/firebase-tools#master<\/pre>\r\n\r\n            The install may warn that <code>node-uuid<\/code> has been superseded with <code>uuid<\/code>.\r\n        <\/li>\r\n        <li>\r\n            Sign in to your Google account using Firebase\r\n\r\n            <pre class=\"brush: powershell; gutter: true; light: false; title: ; toolbar: false; notranslate\" title=\"\">firebase login<\/pre>\r\n        <\/li>\r\n        <li>\r\n            Initialize the project directory\r\n\r\n            <pre class=\"brush: powershell; gutter: true; light: false; title: ; toolbar: false; notranslate\" title=\"\">firebase init<\/pre>\r\n\r\n            Make the following selections  \r\n            <ul>\r\n                <li>\r\n                    Project setup\r\n                    <ul>\r\n                        <li>install all except FireStore,\r\n                        <li>select your project as the default Firebase project (in our case <code>esp-nodejs-mqtt<\/code>).<\/li>\r\n                    <\/ul>\r\n                <\/li>\r\n                <li>\r\n                    Database setup\r\n                    <ul>\r\n                        <li>database rules: <code>database.rules.json<\/code>.<\/li>\r\n                    <\/ul>\r\n                <\/li>\r\n                <li>\r\n                    Functions setup\r\n                    <ul>\r\n                        <li>language to use: <code>JavaScript<\/code>,<\/li>\r\n                        <li>use ESLint: <code>yes<\/code>,<\/li>\r\n                        <li>install dependencies with npm: <code>yes<\/code>.<\/li>\r\n                        <li>This creates the files <code>functions\\package.json<\/code>, <code>functions\\.eslintrc.json<\/code> and <code>functions\\index.js<\/code>.<\/li>\r\n                    <\/ul>\r\n                <\/li>\r\n                <li>\r\n                    Hosting setup\r\n                    <ul>\r\n                        <li>public directory: <code>public<\/code>,<\/li>\r\n                        <li>rewrite all urls to \/index.html: <code>no<\/code>.<\/li>\r\n                        <li>This creates the files <code>public\/404.html<\/code> and <code>public\/index.html<\/code>.<\/li>\r\n                    <\/ul>\r\n                <\/li>\r\n                <li>\r\n                    Storage setup\r\n                    <ul>\r\n                        <li>file for storage rules: <code>storage.rules<\/code>.<\/li>\r\n                    <\/ul>\r\n                <\/li>\r\n                <li>\r\n                    It finishes with creating the configuration file <code>firebase.json<\/code> and project info <code>.firebaserc<\/code>.\r\n                <\/li>\r\n            <\/ul>\r\n        <\/li>\r\n    <\/ol>\r\n<\/p>\r\n\r\n<h3>\r\n    Program the functionality\r\n<\/h3>\r\n<p>\r\n    Time to write some software! Configure and setup a listener in Firebase to store the MQTT messages in BigQuery, and maintain the device&#8217;s state in Firebase realtime store.  This gives the cloud instant access event when the device is in low-power sleep mode and\/or disconnected.\r\n\r\n    <ol>\r\n        <li>\r\n            Point Firebase to the BigQuery table\r\n\r\n            <pre class=\"brush: powershell; gutter: true; light: false; title: ; toolbar: false; notranslate\" title=\"\">firebase functions:config:set ^\r\nbigquery.datasetname=\"esp_nodejs_mqtt\" ^\r\nbigquery.tablename=\"history\"<\/pre>\r\n        <\/li>\r\n        <li>\r\n            Update the file <code>functions\\index.js<\/code> (in your <code>firebase<\/code> directory).  This will\r\n            <ul>\r\n                <li>rxMqtt() receives data from Cloud Pub\/Sub, forward it to Cloud BigQuery and stores the last value in Firebase realtime storage.<\/li>\r\n            <\/ul>\r\n\r\n            <pre class=\"brush: jscript; gutter: true; highlight: [26]; light: false; title: ; toolbar: false; notranslate\" title=\"\">const functions = require('firebase-functions');\r\nconst admin = require('firebase-admin');\r\nadmin.initializeApp(functions.config().firebase);\r\n\r\nconst bigquery = require('@google-cloud\/bigquery')();\r\nconst db = admin.database();\r\nconst cors = require('cors')({ origin: true });\r\n\r\n\/\/ MQTT to BigQuery and maintain current state in Firebase\r\n\r\nfunction updateCurrentStatusInFirebase(data) {\r\n    return db.ref(`\/devices\/${data.deviceId}`).set({\r\n        humidity: data.humidity,\r\n        temp: data.temp,\r\n        timestamp: data.timestamp\r\n    });\r\n}\r\n    \r\nfunction insertIntoBigQuery(data) {\r\n    const dataset = bigquery.dataset(functions.config().bigquery.datasetname);\r\n    const table = dataset.table(functions.config().bigquery.tablename);\r\n    return table.insert(data);\r\n}\r\n\r\nexports.rxMqtt = functions.pubsub\r\n    .topic('mqtt-topic')\r\n    .onPublish(event => {\r\n    console.log('received topic');\r\n        const attributes = event.data.attributes;\r\n        const message = event.data.json;\r\n        const deviceId = attributes['deviceId'];\r\n        const data = {\r\n            humidity: message.hum,\r\n            temp: message.temp,\r\n            deviceId: deviceId,\r\n            timestamp: event.timestamp\r\n        };\r\n        if ( message.hum < 0 || message.hum > 100 ||\r\n                message.temp > 100 || message.temp < -50 ) {\r\n            return null;  \/\/ ignore false readings\r\n        }\r\n        return Promise.all(&#091;\r\n            insertIntoBigQuery(data),\r\n            updateCurrentStatusInFirebase(data)\r\n        &#093;);\r\n    });&#091;\/code&#093;\r\n        <\/li>\r\n        <li>\r\n            Install the modules referenced by <code>functions\\package.json<\/code>.\r\n\r\n            cd functions\r\nnpm install\r\ncd ..<\/pre>\r\n        <\/li>\r\n    <\/ol>\r\n<\/p>\r\n\r\n<h3>\r\n    Deploy\r\n<\/h3>\r\n<p>\r\n    The moment of truth is here: time to deploy the software.\r\n\r\n    <pre class=\"brush: powershell; gutter: true; title: ; toolbar: false; notranslate\" title=\"\">firebase deploy<\/pre>\r\n<\/p>\r\n\r\n<h3>\r\n    Expected results and debugging\r\n<\/h3>\r\n<p>\r\n    <ol>\r\n        <li>\r\n            <ul class=\"breadcrumb\">\r\n                <li><a class=\"nomark hide-anchor\" href=\"https:\/\/accounts.google.com\/ServiceLogin?passive=1209600&#038;osid=1&#038;continue=https:\/\/console.firebase.google.com\/&#038;followup=https:\/\/console.firebase.google.com\/\"><svg version=\"1.1\" id=\"Layer_1\" tyle=\"padding-top:4px;\" height=\"16\" width=\"16\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" xmlns:xlink=\"http:\/\/www.w3.org\/1999\/xlink\" x=\"0px\" y=\"0px\"\t width=\"13.659px\" height=\"18.829px\" viewBox=\"0 0 13.659 18.829\" enable-background=\"new 0 0 13.659 18.829\" xml:space=\"preserve\"><g id=\"Firebase\"><path fill=\"#FEC24C\" d=\"M0,15.198l0.113-0.159l5.392-10.23l0.012-0.109L3.141,0.234C2.94-0.14,2.38-0.045,2.314,0.373L0,15.198z\"\/><g><path id=\"a\" fill=\"#FAA71C\" d=\"M0.066,15.076l0.086-0.167L5.487,4.785L3.116,0.301C2.919-0.07,2.42,0.025,2.355,0.44L0.066,15.076\t\t\tz\"\/><\/g><path fill=\"#F3BD63\" d=\"M7.249,8.077l1.77-1.813L7.248,2.884c-0.168-0.319-0.638-0.321-0.804,0L5.498,4.688v0.153L7.249,8.077\t\tL7.249,8.077z\"\/><g><path id=\"c\" fill=\"#FAA51A\" d=\"M7.218,8l1.721-1.763L7.218,2.961c-0.163-0.311-0.56-0.343-0.724-0.032L5.546,4.762L5.517,4.855\t\t\tL7.218,8z\"\/><\/g><path fill=\"#F58220\" d=\"M0,15.198l0.05-0.053l0.188-0.076l6.899-6.874l0.088-0.238l-1.721-3.28L0,15.198z\"\/><path fill=\"#FCE069\" d=\"M7.47,18.665l6.245-3.482L11.933,4.2c-0.057-0.343-0.479-0.479-0.725-0.231L0,15.198l6.208,3.467\t\tC6.601,18.883,7.078,18.883,7.47,18.665\"\/><path fill=\"#FCCB3F\" d=\"M13.657,15.153l-1.769-10.9c-0.054-0.34-0.405-0.481-0.649-0.235L0.068,15.177l6.14,3.432\t\tc0.39,0.216,0.863,0.216,1.253,0l6.198-3.456H13.657z\"\/><path fill=\"#EEAC38\" d=\"M7.47,18.56c-0.392,0.222-0.869,0.222-1.262,0l-6.159-3.415L0,15.198l6.208,3.467\t\tc0.393,0.219,0.87,0.219,1.262,0l6.245-3.482l-0.016-0.095L7.47,18.56L7.47,18.56z\"\/><\/g><\/svg><\/a><\/li>\r\n                <li style=\"vertical-align: middle;\"><a class=\"nomark hide-anchor\" href=\"#\"><svg id=\"FUNCTIONS_SECTION\" style=\"padding-top:4px;\" height=\"16\" width=\"16\" fill=\"none\" fill-rule=\"evenodd\" height=\"100%\" viewBox=\"0 0 32 32\" width=\"100%\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" fit=\"\" preserveAspectRatio=\"xMidYMid meet\" focusable=\"false\"><g transform=\"translate(1 2)\"><path d=\"M30 8.656L26.01 6.66v14.697L30 19.362zM0 19.35l3.99 1.994V6.647L0 8.642z\" fill=\"#616161\"><\/path><path d=\"M30 16.362l-3.99 1.995v1.995zm-3.99-8.696V9.66L30 11.657z\" fill=\"#424242\"><\/path><path d=\"M21.52 24.833l8.47-8.47v5.64l-5.65 5.65zm0-21.657l8.48 8.48V6.004L24.346.35z\" fill=\"#757575\"><\/path><path d=\"M0 11.642l3.99-1.995V7.652zm3.99 8.698v-1.996L0 16.35z\" fill=\"#424242\"><\/path><path d=\"M8.48 3.172l-8.47 8.47V6L5.66.35zm0 21.656L0 16.348V22l5.654 5.654z\" fill=\"#757575\"><\/path><circle cx=\"8.999\" cy=\"14\" fill=\"#757575\" r=\"2.005\"><\/circle><circle cx=\"14.995\" cy=\"14\" fill=\"#757575\" r=\"2.005\"><\/circle><circle cx=\"20.99\" cy=\"14\" fill=\"#757575\" r=\"2.005\"><\/circle><\/g><\/svg> Functions<\/a><\/li>\r\n                <li style=\"vertical-align: middle;\"><a class=\"nomark hide-anchor\" href=\"#\">Dashboard<\/a><\/li>\r\n            <\/ul>\r\n            <ul>\r\n                <li>The dashboard should show the <code>rxMqtt<\/code> function in the log.<a href=\"\/wp-content\/uploads\/Firebase-functions-rxMqtt.png\"><img loading=\"lazy\" src=\"https:\/\/coert.vonk.one\/wp-content\/uploads\/Firebase-functions-rxMqtt.png\" alt=\"\" width=\"556\" height=\"83\" class=\"alignnone size-full wp-image-24342\" srcset=\"https:\/\/coert.vonk.one\/wp-content\/uploads\/Firebase-functions-rxMqtt.png 556w, https:\/\/coert.vonk.one\/wp-content\/uploads\/Firebase-functions-rxMqtt-400x60.png 400w\" sizes=\"(max-width: 556px) 100vw, 556px\" \/><\/a><\/li>\r\n            <\/ul>\r\n        <\/li>\r\n        <li>\r\n            <ul class=\"breadcrumb\">\r\n                <li><a class=\"nomark hide-anchor\" href=\"https:\/\/accounts.google.com\/ServiceLogin?passive=1209600&#038;osid=1&#038;continue=https:\/\/console.firebase.google.com\/&#038;followup=https:\/\/console.firebase.google.com\/\"><svg version=\"1.1\" id=\"Layer_1\" tyle=\"padding-top:4px;\" height=\"16\" width=\"16\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" xmlns:xlink=\"http:\/\/www.w3.org\/1999\/xlink\" x=\"0px\" y=\"0px\"\t width=\"13.659px\" height=\"18.829px\" viewBox=\"0 0 13.659 18.829\" enable-background=\"new 0 0 13.659 18.829\" xml:space=\"preserve\"><g id=\"Firebase\"><path fill=\"#FEC24C\" d=\"M0,15.198l0.113-0.159l5.392-10.23l0.012-0.109L3.141,0.234C2.94-0.14,2.38-0.045,2.314,0.373L0,15.198z\"\/><g><path id=\"a\" fill=\"#FAA71C\" d=\"M0.066,15.076l0.086-0.167L5.487,4.785L3.116,0.301C2.919-0.07,2.42,0.025,2.355,0.44L0.066,15.076\t\t\tz\"\/><\/g><path fill=\"#F3BD63\" d=\"M7.249,8.077l1.77-1.813L7.248,2.884c-0.168-0.319-0.638-0.321-0.804,0L5.498,4.688v0.153L7.249,8.077\t\tL7.249,8.077z\"\/><g><path id=\"c\" fill=\"#FAA51A\" d=\"M7.218,8l1.721-1.763L7.218,2.961c-0.163-0.311-0.56-0.343-0.724-0.032L5.546,4.762L5.517,4.855\t\t\tL7.218,8z\"\/><\/g><path fill=\"#F58220\" d=\"M0,15.198l0.05-0.053l0.188-0.076l6.899-6.874l0.088-0.238l-1.721-3.28L0,15.198z\"\/><path fill=\"#FCE069\" d=\"M7.47,18.665l6.245-3.482L11.933,4.2c-0.057-0.343-0.479-0.479-0.725-0.231L0,15.198l6.208,3.467\t\tC6.601,18.883,7.078,18.883,7.47,18.665\"\/><path fill=\"#FCCB3F\" d=\"M13.657,15.153l-1.769-10.9c-0.054-0.34-0.405-0.481-0.649-0.235L0.068,15.177l6.14,3.432\t\tc0.39,0.216,0.863,0.216,1.253,0l6.198-3.456H13.657z\"\/><path fill=\"#EEAC38\" d=\"M7.47,18.56c-0.392,0.222-0.869,0.222-1.262,0l-6.159-3.415L0,15.198l6.208,3.467\t\tc0.393,0.219,0.87,0.219,1.262,0l6.245-3.482l-0.016-0.095L7.47,18.56L7.47,18.56z\"\/><\/g><\/svg><\/a><\/li>\r\n                <li style=\"vertical-align: middle;\"><a class=\"nomark hide-anchor\" href=\"#\"><svg id=\"FUNCTIONS_SECTION\" style=\"padding-top:4px;\" height=\"16\" width=\"16\" fill=\"none\" fill-rule=\"evenodd\" height=\"100%\" viewBox=\"0 0 32 32\" width=\"100%\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" fit=\"\" preserveAspectRatio=\"xMidYMid meet\" focusable=\"false\"><g transform=\"translate(1 2)\"><path d=\"M30 8.656L26.01 6.66v14.697L30 19.362zM0 19.35l3.99 1.994V6.647L0 8.642z\" fill=\"#616161\"><\/path><path d=\"M30 16.362l-3.99 1.995v1.995zm-3.99-8.696V9.66L30 11.657z\" fill=\"#424242\"><\/path><path d=\"M21.52 24.833l8.47-8.47v5.64l-5.65 5.65zm0-21.657l8.48 8.48V6.004L24.346.35z\" fill=\"#757575\"><\/path><path d=\"M0 11.642l3.99-1.995V7.652zm3.99 8.698v-1.996L0 16.35z\" fill=\"#424242\"><\/path><path d=\"M8.48 3.172l-8.47 8.47V6L5.66.35zm0 21.656L0 16.348V22l5.654 5.654z\" fill=\"#757575\"><\/path><circle cx=\"8.999\" cy=\"14\" fill=\"#757575\" r=\"2.005\"><\/circle><circle cx=\"14.995\" cy=\"14\" fill=\"#757575\" r=\"2.005\"><\/circle><circle cx=\"20.99\" cy=\"14\" fill=\"#757575\" r=\"2.005\"><\/circle><\/g><\/svg> Functions<\/a><\/li>\r\n                <li style=\"vertical-align: middle;\"><a class=\"nomark hide-anchor\" href=\"#\">Logs<\/a><\/li>\r\n            <\/ul>\r\n            <ul>\r\n                <li>\r\n                    When the device publishes its state using MQTT, the function <code>rxMqtt()<\/code> gets called as shown in the log.\r\n\r\n                    <pre class=\"brush: plain; gutter: true; light: true; title: ; toolbar: false; notranslate\" title=\"\">\r\nrxMqtt  Function execution took 363 ms, finished with status: 'ok'\r\nrxMqtt  received topic\r\nrxMqtt  Function execution started<\/pre>\r\n                <\/li>\r\n            <\/ul>\r\n        <\/li>\r\n    <\/ol>\r\n<\/p>\r\n\r\n<h2>\r\n    BigQuery to DataStudio\r\n<\/h2>\r\n<p>\r\n    Data Studio can visualize data through configurable charts and tables. We are going to use it to visualize the historic data stored in BigQuery.  Alternatively, you can create a web app and pull the data using an HTTPS endpoint as outlined in <a href=\"#appendix-a\">Appendix A<\/a>.\r\n\r\n    <div class=\"align-center\">\r\n        <figure>\r\n            <div class=\"flex-container tight\">\r\n                <a class=\"hide-anchor\" href=\"\/wp-content\/uploads\/block-diagram-datastudio.svg\">\r\n                    <img width=\"450\" src=\"https:\/\/coert.vonk.one\/wp-content\/uploads\/block-diagram-datastudio.svg\" alt=\"Block diagram: Cloud BigQuery to DataStudio\" class=\"alignnone size-full wp-image-24206\" \/>\r\n                <\/a>\r\n            <\/div>\r\n            <figcaption>\r\n                Block diagram: Cloud BigQuery to Data Studio\r\n            <\/figcaption>\r\n        <\/figure>\r\n    <\/div>\r\n<\/p>\r\n\r\n<h3>\r\n    Configure the dashboard\r\n<\/h3>\r\n<p>\r\n    <ol>\r\n        <li>\r\n            <ul class=\"breadcrumb\">\r\n                <li><a class=\"nomark hide-anchor\" href=\"https:\/\/accounts.google.com\/ServiceLogin?passive=1209600&#038;continue=https:\/\/datastudio.google.com\/&#038;followup=https:\/\/datastudio.google.com\/<mpl=datastudio\"><svg version=\"1.1\" id=\"Data_Studio\" height=\"16\" width=\"16\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" xmlns:xlink=\"http:\/\/www.w3.org\/1999\/xlink\" viewBox=\"0 0 192 192\"><g><path fill=\"#3367D6\" d=\"M172,32.2c0-6.7-5.5-12.2-12.2-12.2H32.2C25.5,20,20,25.5,20,32.2v127.7c0,6.7,5.5,12.2,12.2,12.2h62.4c42.9,0,77.4-32.7,77.4-76.9C172,82.6,172,32.2,172,32.2z\"\/><\/g><linearGradient id=\"SVGID_1_\" gradientUnits=\"userSpaceOnUse\" x1=\"69.8761\" y1=\"70.1239\" x2=\"193.092\" y2=\"193.3398\"><stop  offset=\"0\" style=\"stop-color:#263238;stop-opacity:0.2\"\/><stop  offset=\"0.4313\" style=\"stop-color:#263238;stop-opacity:0\"\/><\/linearGradient><path fill=\"url(#SVGID_1_)\" d=\"M172,95.1c0-4.3,0-13,0-22.6L120.2,21L20,120l52.1,52h22.5C137.5,172,172,139.3,172,95.1z\"\/><path opacity=\"0.2\" fill=\"#FFFFFF\" d=\"M67.1,21h92.7c6.7,0,12.2,5.5,12.2,12.2v-1c0-6.7-5.5-12.2-12.2-12.2H67.1V21z\"\/><g><g><path fill=\"#64B5F6\" d=\"M32.2,20C25.5,20,20,25.5,20,32.2V120c0,0,30.1,0,49.9,0c28.4,0,50.1-23,50.1-50.2V20H32.2z\"\/><\/g><\/g><path opacity=\"0.2\" fill=\"#FFFFFF\" d=\"M120,21H32.2C25.5,21,20,26.5,20,33.2v-1C20,25.5,25.5,20,32.2,20H120V21z\"\/><g opacity=\"0.2\"><path fill=\"#263238\" d=\"M94.6,171H32.2c-6.7,0-12.2-5.5-12.2-12.2v1c0,6.7,5.5,12.2,12.2,12.2h62.4c42.9,0,77.4-32.7,77.4-76.9c0-0.3,0-0.6,0-1C172,138.3,137.5,171,94.6,171z\"\/><\/g><rect fill=\"none\" width=\"192\" height=\"192\"\/><g><linearGradient id=\"SVGID_2_\" gradientUnits=\"userSpaceOnUse\" x1=\"20\" y1=\"96\" x2=\"172\" y2=\"96\"><stop  offset=\"0\" style=\"stop-color:#FFFFFF;stop-opacity:0.1\"\/><stop  offset=\"1\" style=\"stop-color:#FFFFFF;stop-opacity:0\"\/><\/linearGradient><path fill=\"url(#SVGID_2_)\" d=\"M172,32.2c0-6.7-5.5-12.2-12.2-12.2H32.2C25.5,20,20,25.5,20,32.2v127.7c0,6.7,5.5,12.2,12.2,12.2h62.4c42.9,0,77.4-32.7,77.4-76.9C172,82.6,172,32.2,172,32.2z\"\/><\/g><\/svg><\/a><\/li>\r\n                <li style=\"vertical-align: middle;\"><a class=\"nomark hide-anchor\" href=\"#\"><svg id=\"FUNCTIONS_SECTION\" style=\"padding-top:4px;\" height=\"16\" width=\"16\" fill=\"none\" fill-rule=\"evenodd\" height=\"100%\" viewBox=\"0 0 32 32\" width=\"100%\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" fit=\"\" preserveAspectRatio=\"xMidYMid meet\" focusable=\"false\"><g transform=\"translate(1 2)\"><path d=\"M30 8.656L26.01 6.66v14.697L30 19.362zM0 19.35l3.99 1.994V6.647L0 8.642z\" fill=\"#616161\"><\/path><path d=\"M30 16.362l-3.99 1.995v1.995zm-3.99-8.696V9.66L30 11.657z\" fill=\"#424242\"><\/path><path d=\"M21.52 24.833l8.47-8.47v5.64l-5.65 5.65zm0-21.657l8.48 8.48V6.004L24.346.35z\" fill=\"#757575\"><\/path><path d=\"M0 11.642l3.99-1.995V7.652zm3.99 8.698v-1.996L0 16.35z\" fill=\"#424242\"><\/path><path d=\"M8.48 3.172l-8.47 8.47V6L5.66.35zm0 21.656L0 16.348V22l5.654 5.654z\" fill=\"#757575\"><\/path><circle cx=\"8.999\" cy=\"14\" fill=\"#757575\" r=\"2.005\"><\/circle><circle cx=\"14.995\" cy=\"14\" fill=\"#757575\" r=\"2.005\"><\/circle><circle cx=\"20.99\" cy=\"14\" fill=\"#757575\" r=\"2.005\"><\/circle><\/g><\/svg> Functions<\/a><\/li>\r\n                <li style=\"vertical-align: middle;\"><a class=\"nomark hide-anchor\" href=\"#\"><span class=\"key-press-blue\" style=\"background-color: inherit; font-size: 11px;\">+<\/span> Start a new report<\/a><\/li>\r\n            <\/ul>\r\n            <ul>\r\n                <li>\r\n                    Add the data source <code>history<\/code><\/a> to report\r\n                <\/li>\r\n                <li>\r\n                    Insert a time series (draw it at the top quarter of the canvas)\r\n                    <ul>\r\n                        <li>The time dimension will be pre-filled with <code>timestamp<\/code><\/li>\r\n                        <li>Metric: <code>temp<\/code> (and remove others); click on the \"123\" in front of the metric field, and select <code>average<\/code><\/li>\r\n                        <li>Data range: <code>custom<\/code>, include today and <code>last 7 days<\/code><\/li>\r\n                    <\/ul>\r\n                <\/li>\r\n                <li>\r\n                    Copy and paste the temperature graph below it, and change the field to <code>humidity<\/code>.\r\n                <\/li>\r\n                <li>\r\n                    Insert a table (draw it at the bottom half of the canvas)\r\n                    <ul>\r\n                        <li>Dimension: <code>deviceId<\/code> and <code>timestamp<\/code> (and remove others)<\/li>\r\n                        <li>Metric: <code>temp<\/code> and <code>humidity<\/code> (and remove others); click on the \"123\" labels in front of the metric fields, and select <code>average<\/code><\/li>\r\n                        <li>Data range: <code>custom<\/code>, include today and <code>last 7 days<\/code><\/li>\r\n                    <\/ul>\r\n                <\/li>\r\n                <li>\r\n                    To change the theme to dark\r\n                    <ul>\r\n                        <li>Edit > Select none<\/li>\r\n                        <li>Theme > current Theme = <code>Simple Dark<\/code><\/li>\r\n                    <ul>\r\n                <\/li>\r\n            <\/ul>\r\n        <\/li>\r\n    <\/ol>\r\n<\/p>\r\n\r\n<h3>\r\n    Expected results\r\n<\/h3>\r\n<p>\r\n    This was one of the easiest visualization methods that I have encountered.  Hopefully, you get a similar dashboard.\r\n\r\n    <div class=\"align-center\">\r\n        <figure>\r\n            <div class=\"flex-container tight\">\r\n                <a href=\"\/wp-content\/uploads\/datastudio-screenshot1.png\">\r\n                    <img src=\"https:\/\/coert.vonk.one\/wp-content\/uploads\/datastudio-screenshot1.png\" alt=\"\" class=\"alignnone size-full wp-image-24365\" width=\"400\" \/>\r\n                <\/a>\r\n            <\/div>\r\n            <figcaption>\r\n                Screen shot of visualization in Data Studio\r\n            <\/figcaption>\r\n        <\/figure>\r\n    <\/div>\r\n<\/p>\r\n\r\n<h2>\r\n    Google Assistent\r\n<\/h3>\r\n\r\n<h3>\r\n    The players\r\n<\/h3>\r\n\r\n<h4>\r\n    Dialogflow\r\n<\/h4>\r\n<p>\r\n    Dialogflow provides a server-side infrastructure to create conversational scenarios, then build advanced dialogues to manage the conversation flow with the user.\r\n<\/p>\r\n\r\n<h4>\r\n    Google Assistant\r\n<\/h4>\r\n<p>\r\n    Google Assistant combines machine learning, speech recognition and natural language understanding. It allows you to have a conversation with the device.\r\n<\/p>\r\n\r\n<h3>\r\n    Actions on Google\r\n<\/h3>\r\n<p>\r\n    <ol>\r\n        <li>\r\n            <ul class=\"breadcrumb\">\r\n                <li><a class=\"nomark hide-anchor\" href=\"https:\/\/accounts.google.com\/ServiceLogin?passive=1209600&#038;osid=1&#038;continue=https:\/\/console.actions.google.com\/&#038;followup=https:\/\/console.actions.google.com\/\"><svg version=\"1.1\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" xmlns:xlink=\"http:\/\/www.w3.org\/1999\/xlink\" viewBox=\"230.125 231.125 51.875 49.563\"><g><circle fill=\"#4285F4\" cx=\"246.001\" cy=\"246.995\" r=\"15.8\"\/><path fill=\"#34A853\" d=\"M281.969,248.535c0,1.774-1.439,3.211-3.211,3.211c-1.773,0-3.212-1.437-3.212-3.211c0-1.773,1.438-3.211,3.212-3.211C280.529,245.324,281.969,246.762,281.969,248.535z\"\/><path fill=\"#EA4335\" d=\"M276.188,256.371c0,3.547-2.875,6.422-6.423,6.422c-3.547,0-6.424-2.875-6.424-6.422s2.877-6.423,6.424-6.423C273.313,249.948,276.188,252.824,276.188,256.371z\"\/><path fill=\"#FBBC05\" d=\"M277.473,272.942c0,4.257-3.451,7.707-7.707,7.707c-4.258,0-7.708-3.45-7.708-7.707s3.45-7.708,7.708-7.708C274.021,265.234,277.473,268.686,277.473,272.942z\"\/><\/g><\/svg><\/a><\/li>\r\n                <li style=\"vertical-align: middle;\"><a class=\"nomark hide-anchor\" href=\"#\"><span class=\"key-press-blue\">+<\/span> Add\/import project<\/a><\/li>\r\n            <\/ul>\r\n            <ul>\r\n                <li>Import your project (in my case: <code>esp-nodejs-mqtt<\/code>)<\/li>\r\n            <\/ul>\r\n        <\/li>\r\n        <li>\r\n            <ul class=\"breadcrumb\">\r\n                <li><a class=\"nomark hide-anchor\" href=\"https:\/\/accounts.google.com\/ServiceLogin?passive=1209600&#038;osid=1&#038;continue=https:\/\/console.actions.google.com\/&#038;followup=https:\/\/console.actions.google.com\/\"><svg version=\"1.1\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" xmlns:xlink=\"http:\/\/www.w3.org\/1999\/xlink\" viewBox=\"230.125 231.125 51.875 49.563\"><g><circle fill=\"#4285F4\" cx=\"246.001\" cy=\"246.995\" r=\"15.8\"\/><path fill=\"#34A853\" d=\"M281.969,248.535c0,1.774-1.439,3.211-3.211,3.211c-1.773,0-3.212-1.437-3.212-3.211c0-1.773,1.438-3.211,3.212-3.211C280.529,245.324,281.969,246.762,281.969,248.535z\"\/><path fill=\"#EA4335\" d=\"M276.188,256.371c0,3.547-2.875,6.422-6.423,6.422c-3.547,0-6.424-2.875-6.424-6.422s2.877-6.423,6.424-6.423C273.313,249.948,276.188,252.824,276.188,256.371z\"\/><path fill=\"#FBBC05\" d=\"M277.473,272.942c0,4.257-3.451,7.707-7.707,7.707c-4.258,0-7.708-3.45-7.708-7.707s3.45-7.708,7.708-7.708C274.021,265.234,277.473,268.686,277.473,272.942z\"\/><\/g><\/svg><\/a><\/li>\r\n                <li><a class=\"nomark hide-anchor\" href=\"#\"><svg version=\"1.1\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" xmlns:xlink=\"http:\/\/www.w3.org\/1999\/xlink\" viewBox=\"0 0 479.333 480\"><g><path id=\"aog_nav20_actions\" fill=\"#010101\" d=\"M426.833,480.5c14.667,0,27.167-5.167,37.5-15.5s15.5-22.833,15.5-37.5v-374c0-14.667-5.167-27.167-15.5-37.5S441.5,0.5,426.833,0.5h-374c-14.667,0-27.167,5.167-37.5,15.5s-15.5,22.833-15.5,37.5v374c0,14.667,5.167,27.167,15.5,37.5s22.833,15.5,37.5,15.5H426.833z M373.833,320.5v53h-267v-53H373.833z M373.833,213.5v54h-267v-54H373.833z M373.833,107.5v53h-267v-53H373.833z\"\/><\/g><\/svg> Actions<\/a><\/li>\r\n            <\/ul>\r\n            <ul>\r\n                <li>...<\/li>\r\n            <\/ul>\r\n        <\/li>\r\n        <li>\r\n            <ul class=\"breadcrumb\">\r\n                <li><a class=\"nomark hide-anchor\" href=\"https:\/\/accounts.google.com\/ServiceLogin?service=cloudconsole&#038;passive=1209600&#038;osid=1&#038;continue=https:\/\/console.cloud.google.com\/?ref%3Dhttps:\/\/coert.vonk.one&#038;followup=https:\/\/console.cloud.google.com\/?ref%3Dhttps:\/\/coert.vonk.one\">\u2630<\/a><\/li>\r\n                <li><a class=\"nomark hide-anchor\" href=\"#\"><svg id=\"API_SECTION\" fill=\"currentColor\" fill-rule=\"evenodd\" viewBox=\"0 0 24 24\"  xmlns=\"http:\/\/www.w3.org\/2000\/svg\" fit=\"\" preserveAspectRatio=\"xMidYMid meet\" focusable=\"false\"><path d=\"M4 6c-1.125 0-2 .88-2 2v10h2v-5h2v5h2V8c0-1.12-.875-2-2-2H4zm0 5V8h2v3l-2 2v-2zm7-5c-1.125 0-2 .88-2 2v10h2v-5h2c1.125 0 2-.88 2-2V8c0-1.12-.875-2-2-2h-2zm0 5V8h2v3l-2 2v-2zm7-3h2l-2 2v6h-2v2h6v-2h-2V8h2V6h-6v2z\"><\/path><path d=\"M4 13v-2h2zm7 0v-2h2zm7-3V8h2z\" opacity=\".6\"><\/path><\/svg> APIs & Services<\/a><\/li>\r\n                <li><a class=\"nomark hide-anchor\" href=\"#\"><svg id=\"\" viewBox=\"0 0 18 18\" fit=\"\" preserveAspectRatio=\"xMidYMid meet\" focusable=\"false\"><path d=\"M14 7V2.02h-2V7h-2V2.02H8V7H6V2.02H4.097V7H3v1h12V7zm0 3.02h-2V15h-2v-4.98H8V15H6v-4.98H4.097V15H3v1h12v-1h-1z\" fill-rule=\"evenodd\"><\/path><\/svg><span  alignment-baseline=\"middle\"> Library<\/span><\/a><\/li>\r\n            <\/ul>\r\n            <ul>\r\n                <li>enable \" Google HomeGraph\"<\/li>\r\n            <\/ul>\r\n        <\/li>\r\n    <\/ol>\r\n<\/p>\r\n\r\n<h3>\r\n    Dialog Flow\r\n<\/h3>\r\n<p>\r\n    We use Dialog Flow to to connect to Google Assistant.  It will be able to recall the previous device readings and pass a instruction to the device.  To get started, head over <a href=\"https:\/\/accounts.google.com\/ServiceLogin?service=cloudconsole&#038;passive=1209600&#038;osid=1&#038;continue=https:\/\/console.cloud.google.com\/?ref%3Dhttps:\/\/coert.vonk.one&#038;followup=https:\/\/console.cloud.google.com\/?ref%3Dhttps:\/\/coert.vonk.one\">Cloud Console<\/a> and create a project and prepare it for Message Queuing Telemetry Transport (MQTT).  MQTT is a lightweight machine-to-machine publish\/subscribe protocol, often used where a small code footprint is required and\/or network bandwidth is at a premium. \r\n<\/p>\r\n\r\n<h2 id=\"appendix-a\" class=\"nocount\">\r\n    APPENDIX A: Cloud Storage to WebApp\r\n<\/h2>\r\n<p>\r\n    This near vanilla copy of Alvaro Viebrantz' <code>WebApp<\/code> code is provided for completeness [3]. The public web app uses <a href=\"https:\/\/github.com\/material-components\/material-components-web\/tree\/master\/packages\/material-components-web\">Web Material Component<\/a> and <a href=\"https:\/\/www.chartjs.org\/\">Chart.JS<\/a> for the charts.\r\n\r\n    <div class=\"align-center\">\r\n        <figure>\r\n            <div class=\"flex-container tight\">\r\n                <a class=\"hide-anchor\" href=\"\/wp-content\/uploads\/block-diagram-webapp.svg\">\r\n                    <img width=\"450\" src=\"https:\/\/coert.vonk.one\/wp-content\/uploads\/block-diagram-webapp.svg\" alt=\"Block diagram: Cloud BigQuery to WebApp\" class=\"alignnone size-full wp-image-24206\" \/>\r\n                <\/a>\r\n            <\/div>\r\n            <figcaption>\r\n                Block diagram: Cloud BigQuery to WebApp\r\n            <\/figcaption>\r\n        <\/figure>\r\n    <\/div>\r\n<\/p>\r\n\r\n<h3>\r\n    Program the functionality\r\n<\/h3>\r\n<p>\r\n    Configure and setup a report generator that listens on HTTPS.\r\n    <ol>\r\n        <li>\r\n            Point Firebase to the BigQuery table\r\n\r\n            <pre class=\"brush: powershell; gutter: true; light: false; title: ; toolbar: false; notranslate\" title=\"\">firebase functions:config:set ^\r\nbigquery.datasetname=\"esp_nodejs_mqtt\" ^\r\nbigquery.tablename=\"history\"<\/pre>\r\n        <\/li>\r\n        <li>\r\n            Add code to the end of <code>functions\\index.js<\/code> (in your <code>firebase<\/code> directory).  This will\r\n            <ul>\r\n                <li><code>getWeek()<\/code> functions as an HTTPS endpoint for the web app by supplying the last 7 days of data from BigQuery.<\/li>\r\n            <\/ul>\r\n            \r\n            <pre class=\"brush: jscript; gutter: true; light: false; title: ; toolbar: false; notranslate\" title=\"\">\/\/ BigQuery and current state to HTTPS endpoint\r\n\r\nconst cors = require('cors')({ origin: true });\r\n\r\nexports.getWeek = functions.https.onRequest( (req, res) => {\r\n    const project = functions.config().firebase.projectId;\r\n    const dataset = functions.config().bigquery.datasetname;\r\n    const tablename = functions.config().bigquery.tablename;\r\n    const table = '`' + project + '.' + dataset + '.' + tablename + '`';\r\n    const query = `\r\n    SELECT \r\n        TIMESTAMP_TRUNC(data.timestamp, HOUR, 'America\/Los_Angeles') AS data_hour,\r\n        avg(data.temp) as avg_temp,\r\n        avg(data.humidity) as avg_hum,\r\n        min(data.temp) as min_temp,\r\n        max(data.temp) as max_temp,\r\n        min(data.humidity) as min_hum,\r\n        max(data.humidity) as max_hum,\r\n        count(*) as data_points      \r\n    FROM ${table} data\r\n    WHERE data.timestamp > TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)\r\n    GROUP by data_hour\r\n    ORDER by data_hour\r\n    `;\r\n    bigquery\r\n    .query({\r\n        query: query,\r\n        useLegacySql: false\r\n    })\r\n    .then(results => {\r\n        const rows = results[0];\r\n        return cors(req, res, () => {\r\n            res.json(rows);\r\n        });\r\n    })\r\n    .catch(err => {\r\n        res.status(500).send(err);\r\n        console.error('ERROR:', err);\r\n    });\r\n});<\/pre>\r\n        <\/li>\r\n        <li>\r\n            Install the modules referenced by <code>functions\\package.json<\/code>.\r\n        <pre class=\"brush: powershell; gutter: true; light: false; title: ; toolbar: false; notranslate\" title=\"\">cd functions\r\nnpm install\r\ncd ..<\/pre>\r\n        <\/li>\r\n        <li>\r\n            Update <code>database.rules.json<\/code> to allow public read access to the database.  No ideal, as an alternative you can have the user authenticate using OAuth.\r\n\r\n            <pre class=\"brush: jscript; gutter: true; highlight: [3]; light: false; title: ; toolbar: false; notranslate\" title=\"\">{\r\n    \"rules\": {\r\n    \".read\": \"true\",\r\n    \".write\": \"auth != null\"\r\n    }\r\n}<\/pre>\r\n        <\/li>\r\n    <\/ol>\r\n<\/p>\r\n\r\n<h3>\r\n    Deploy\r\n<\/h3>\r\n<p>\r\n    Time to see it all in action.\r\n\r\n    <pre class=\"brush: powershell; gutter: true; title: ; toolbar: false; notranslate\" title=\"\">firebase deploy<\/pre>\r\n<\/p>\r\n\r\n<h3>\r\n    Expected results and debugging\r\n<\/h3>\r\n<p>\r\n    <ol>\r\n        <li>\r\n            <ul class=\"breadcrumb\">\r\n                <li><a class=\"nomark hide-anchor\" href=\"https:\/\/accounts.google.com\/ServiceLogin?passive=1209600&#038;osid=1&#038;continue=https:\/\/console.firebase.google.com\/&#038;followup=https:\/\/console.firebase.google.com\/\"><svg version=\"1.1\" id=\"Layer_1\" tyle=\"padding-top:4px;\" height=\"16\" width=\"16\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" xmlns:xlink=\"http:\/\/www.w3.org\/1999\/xlink\" x=\"0px\" y=\"0px\"\t width=\"13.659px\" height=\"18.829px\" viewBox=\"0 0 13.659 18.829\" enable-background=\"new 0 0 13.659 18.829\" xml:space=\"preserve\"><g id=\"Firebase\"><path fill=\"#FEC24C\" d=\"M0,15.198l0.113-0.159l5.392-10.23l0.012-0.109L3.141,0.234C2.94-0.14,2.38-0.045,2.314,0.373L0,15.198z\"\/><g><path id=\"a\" fill=\"#FAA71C\" d=\"M0.066,15.076l0.086-0.167L5.487,4.785L3.116,0.301C2.919-0.07,2.42,0.025,2.355,0.44L0.066,15.076\t\t\tz\"\/><\/g><path fill=\"#F3BD63\" d=\"M7.249,8.077l1.77-1.813L7.248,2.884c-0.168-0.319-0.638-0.321-0.804,0L5.498,4.688v0.153L7.249,8.077\t\tL7.249,8.077z\"\/><g><path id=\"c\" fill=\"#FAA51A\" d=\"M7.218,8l1.721-1.763L7.218,2.961c-0.163-0.311-0.56-0.343-0.724-0.032L5.546,4.762L5.517,4.855\t\t\tL7.218,8z\"\/><\/g><path fill=\"#F58220\" d=\"M0,15.198l0.05-0.053l0.188-0.076l6.899-6.874l0.088-0.238l-1.721-3.28L0,15.198z\"\/><path fill=\"#FCE069\" d=\"M7.47,18.665l6.245-3.482L11.933,4.2c-0.057-0.343-0.479-0.479-0.725-0.231L0,15.198l6.208,3.467\t\tC6.601,18.883,7.078,18.883,7.47,18.665\"\/><path fill=\"#FCCB3F\" d=\"M13.657,15.153l-1.769-10.9c-0.054-0.34-0.405-0.481-0.649-0.235L0.068,15.177l6.14,3.432\t\tc0.39,0.216,0.863,0.216,1.253,0l6.198-3.456H13.657z\"\/><path fill=\"#EEAC38\" d=\"M7.47,18.56c-0.392,0.222-0.869,0.222-1.262,0l-6.159-3.415L0,15.198l6.208,3.467\t\tc0.393,0.219,0.87,0.219,1.262,0l6.245-3.482l-0.016-0.095L7.47,18.56L7.47,18.56z\"\/><\/g><\/svg><\/a><\/li>\r\n                <li style=\"vertical-align: middle;\"><a class=\"nomark hide-anchor\" href=\"#\"><svg id=\"FUNCTIONS_SECTION\" style=\"padding-top:4px;\" height=\"16\" width=\"16\" fill=\"none\" fill-rule=\"evenodd\" height=\"100%\" viewBox=\"0 0 32 32\" width=\"100%\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" fit=\"\" preserveAspectRatio=\"xMidYMid meet\" focusable=\"false\"><g transform=\"translate(1 2)\"><path d=\"M30 8.656L26.01 6.66v14.697L30 19.362zM0 19.35l3.99 1.994V6.647L0 8.642z\" fill=\"#616161\"><\/path><path d=\"M30 16.362l-3.99 1.995v1.995zm-3.99-8.696V9.66L30 11.657z\" fill=\"#424242\"><\/path><path d=\"M21.52 24.833l8.47-8.47v5.64l-5.65 5.65zm0-21.657l8.48 8.48V6.004L24.346.35z\" fill=\"#757575\"><\/path><path d=\"M0 11.642l3.99-1.995V7.652zm3.99 8.698v-1.996L0 16.35z\" fill=\"#424242\"><\/path><path d=\"M8.48 3.172l-8.47 8.47V6L5.66.35zm0 21.656L0 16.348V22l5.654 5.654z\" fill=\"#757575\"><\/path><circle cx=\"8.999\" cy=\"14\" fill=\"#757575\" r=\"2.005\"><\/circle><circle cx=\"14.995\" cy=\"14\" fill=\"#757575\" r=\"2.005\"><\/circle><circle cx=\"20.99\" cy=\"14\" fill=\"#757575\" r=\"2.005\"><\/circle><\/g><\/svg> Functions<\/a><\/li>\r\n                <li style=\"vertical-align: middle;\"><a class=\"nomark hide-anchor\" href=\"#\">Dashboard<\/a><\/li>\r\n            <\/ul>\r\n            <ul>\r\n                <li>The dashboard should show the <code>getWeek<\/code> function as evident from the log.<a href=\"\/wp-content\/uploads\/Firebase-functions-getWeek.png\"><img loading=\"lazy\" src=\"https:\/\/coert.vonk.one\/wp-content\/uploads\/Firebase-functions-getWeek.png\" alt=\"\" width=\"555\" height=\"81\" class=\"aligncenter size-full wp-image-24343\" srcset=\"https:\/\/coert.vonk.one\/wp-content\/uploads\/Firebase-functions-getWeek.png 555w, https:\/\/coert.vonk.one\/wp-content\/uploads\/Firebase-functions-getWeek-400x58.png 400w\" sizes=\"(max-width: 555px) 100vw, 555px\" \/><\/a><\/li>\r\n            <\/ul>\r\n        <\/li>\r\n        <li>\r\n            When you access the HTTPS endpoint URL listed on the Dashboard, it should return something like shown below\r\n            <pre class=\"brush: jscript; gutter: true; light: true; title: ; toolbar: false; notranslate\" title=\"\">[\r\n    {\"data_hour\":{\"value\":\"2018-03-11 03:00:00.000\"},\r\n    \"avg_temp\":23,\"avg_hum\":53.25,\r\n    \"min_temp\":23,\"max_temp\":23,\"min_hum\":47,\"max_hum\":56,\"data_points\":4},\r\n    {\"data_hour\":{\"value\":\"2018-03-11 04:00:00.000\"},\r\n    \"avg_temp\":23,\"avg_hum\":54.2,\r\n    \"min_temp\":23,\"max_temp\":23,\"min_hum\":53,\"max_hum\":55,\"data_points\":5},\r\n    {\"data_hour\":{\"value\":\"2018-03-11 05:00:00.000\"},\r\n    \"avg_temp\":23,\"avg_hum\":52.2,\r\n    \"min_temp\":23,\"max_temp\":23,\"min_hum\":47,\"max_hum\":54,\"data_points\":5},\r\n    {\"data_hour\":{\"value\":\"2018-03-11 06:00:00.000\"},\r\n    \"avg_temp\":22.333333333333332,\"avg_hum\":54.666666666666664,\r\n    \"min_temp\":22,\"max_temp\":23,\"min_hum\":54,\"max_hum\":55,\"data_points\":3}\r\n]<\/pre>\r\n        <\/li>\r\n        <li>\r\n            <ul class=\"breadcrumb\">\r\n                <li><a class=\"nomark hide-anchor\" href=\"https:\/\/accounts.google.com\/ServiceLogin?passive=1209600&#038;osid=1&#038;continue=https:\/\/console.firebase.google.com\/&#038;followup=https:\/\/console.firebase.google.com\/\"><svg version=\"1.1\" id=\"Layer_1\" tyle=\"padding-top:4px;\" height=\"16\" width=\"16\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" xmlns:xlink=\"http:\/\/www.w3.org\/1999\/xlink\" x=\"0px\" y=\"0px\"\t width=\"13.659px\" height=\"18.829px\" viewBox=\"0 0 13.659 18.829\" enable-background=\"new 0 0 13.659 18.829\" xml:space=\"preserve\"><g id=\"Firebase\"><path fill=\"#FEC24C\" d=\"M0,15.198l0.113-0.159l5.392-10.23l0.012-0.109L3.141,0.234C2.94-0.14,2.38-0.045,2.314,0.373L0,15.198z\"\/><g><path id=\"a\" fill=\"#FAA71C\" d=\"M0.066,15.076l0.086-0.167L5.487,4.785L3.116,0.301C2.919-0.07,2.42,0.025,2.355,0.44L0.066,15.076\t\t\tz\"\/><\/g><path fill=\"#F3BD63\" d=\"M7.249,8.077l1.77-1.813L7.248,2.884c-0.168-0.319-0.638-0.321-0.804,0L5.498,4.688v0.153L7.249,8.077\t\tL7.249,8.077z\"\/><g><path id=\"c\" fill=\"#FAA51A\" d=\"M7.218,8l1.721-1.763L7.218,2.961c-0.163-0.311-0.56-0.343-0.724-0.032L5.546,4.762L5.517,4.855\t\t\tL7.218,8z\"\/><\/g><path fill=\"#F58220\" d=\"M0,15.198l0.05-0.053l0.188-0.076l6.899-6.874l0.088-0.238l-1.721-3.28L0,15.198z\"\/><path fill=\"#FCE069\" d=\"M7.47,18.665l6.245-3.482L11.933,4.2c-0.057-0.343-0.479-0.479-0.725-0.231L0,15.198l6.208,3.467\t\tC6.601,18.883,7.078,18.883,7.47,18.665\"\/><path fill=\"#FCCB3F\" d=\"M13.657,15.153l-1.769-10.9c-0.054-0.34-0.405-0.481-0.649-0.235L0.068,15.177l6.14,3.432\t\tc0.39,0.216,0.863,0.216,1.253,0l6.198-3.456H13.657z\"\/><path fill=\"#EEAC38\" d=\"M7.47,18.56c-0.392,0.222-0.869,0.222-1.262,0l-6.159-3.415L0,15.198l6.208,3.467\t\tc0.393,0.219,0.87,0.219,1.262,0l6.245-3.482l-0.016-0.095L7.47,18.56L7.47,18.56z\"\/><\/g><\/svg><\/a><\/li>\r\n                <li style=\"vertical-align: middle;\"><a class=\"nomark hide-anchor\" href=\"#\"><svg id=\"FUNCTIONS_SECTION\" style=\"padding-top:4px;\" height=\"16\" width=\"16\" fill=\"none\" fill-rule=\"evenodd\" height=\"100%\" viewBox=\"0 0 32 32\" width=\"100%\" xmlns=\"http:\/\/www.w3.org\/2000\/svg\" fit=\"\" preserveAspectRatio=\"xMidYMid meet\" focusable=\"false\"><g transform=\"translate(1 2)\"><path d=\"M30 8.656L26.01 6.66v14.697L30 19.362zM0 19.35l3.99 1.994V6.647L0 8.642z\" fill=\"#616161\"><\/path><path d=\"M30 16.362l-3.99 1.995v1.995zm-3.99-8.696V9.66L30 11.657z\" fill=\"#424242\"><\/path><path d=\"M21.52 24.833l8.47-8.47v5.64l-5.65 5.65zm0-21.657l8.48 8.48V6.004L24.346.35z\" fill=\"#757575\"><\/path><path d=\"M0 11.642l3.99-1.995V7.652zm3.99 8.698v-1.996L0 16.35z\" fill=\"#424242\"><\/path><path d=\"M8.48 3.172l-8.47 8.47V6L5.66.35zm0 21.656L0 16.348V22l5.654 5.654z\" fill=\"#757575\"><\/path><circle cx=\"8.999\" cy=\"14\" fill=\"#757575\" r=\"2.005\"><\/circle><circle cx=\"14.995\" cy=\"14\" fill=\"#757575\" r=\"2.005\"><\/circle><circle cx=\"20.99\" cy=\"14\" fill=\"#757575\" r=\"2.005\"><\/circle><\/g><\/svg> Functions<\/a><\/li>\r\n                <li style=\"vertical-align: middle;\"><a class=\"nomark hide-anchor\" href=\"#\">Logs<\/a><\/li>\r\n            <\/ul>\r\n            <ul>\r\n                <li>\r\n                    Every time you access your the HTTPS URL listed on the Dashboard, <code>getWeek()<\/code> gets called.\r\n\r\n                    <pre class=\"brush: plain; gutter: true; light: true; title: ; toolbar: false; notranslate\" title=\"\">getWeek Function execution took 1740 ms, finished with status code: 200\r\ngetWeek Function execution started<\/pre>\r\n                <\/li>\r\n            <\/ul>\r\n        <\/li>\r\n    <\/ol>\r\n<\/p>\r\n\r\n<h3>\r\n    WebApp\r\n<\/h3>\r\n<p>\r\n    (http:\/\/material-components-web.appspot.com\/)\r\n    <ol>\r\n        <li>Modify the public web page <code>public\\index.html<\/code>\r\n        <pre class=\"brush: xml; gutter: true; light: false; title: ; toolbar: false; notranslate\" title=\"\"><!DOCTYPE html>\r\n    <html>\r\n        <head>\r\n        <meta charset=\"utf-8\">\r\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\r\n        <title>Welcome esp-nodejs-mqtt<\/title>\r\n\r\n        <!-- update the version number as needed -->\r\n        <script defer src=\"https:\/\/coert.vonk.one\/__\/firebase\/4.11.0\/firebase-app.js\"><\/script>\r\n        <!-- include only the Firebase features as you need -->\r\n        <script defer src=\"https:\/\/coert.vonk.one\/__\/firebase\/4.11.0\/firebase-auth.js\"><\/script>\r\n        <script defer src=\"https:\/\/coert.vonk.one\/__\/firebase\/4.11.0\/firebase-database.js\"><\/script>\r\n        <script defer src=\"https:\/\/coert.vonk.one\/__\/firebase\/4.11.0\/firebase-messaging.js\"><\/script>\r\n        <script defer src=\"https:\/\/coert.vonk.one\/__\/firebase\/4.11.0\/firebase-storage.js\"><\/script>\r\n        <!-- initialize the SDK after all desired features are loaded -->\r\n        <script defer src=\"https:\/\/coert.vonk.one\/__\/firebase\/init.js\"><\/script>\r\n        <script defer src=\"https:\/\/cdn.firebase.com\/libs\/firebaseui\/2.5.1\/firebaseui.js\"><\/script>\r\n        \r\n        <link type=\"text\/css\" rel=\"stylesheet\" href=\"https:\/\/cdn.firebase.com\/libs\/firebaseui\/2.5.1\/firebaseui.css\" \/>\r\n        <script defer src=\"app.js\"><\/script>    \r\n        <link rel=\"stylesheet\" href=\"https:\/\/fonts.googleapis.com\/icon?family=Material+Icons\">\r\n        <link rel=\"stylesheet\" href=\"https:\/\/fonts.googleapis.com\/css?family=Roboto+Mono\">\r\n        <link rel=\"stylesheet\" href=\"https:\/\/fonts.googleapis.com\/css?family=Roboto:300,400,500\">\r\n        <link rel=\"stylesheet\" href=\"https:\/\/unpkg.com\/material-components-web@latest\/dist\/material-components-web.min.css\">\r\n        <style>\r\n            :root {\r\n            --mdc-theme-primary: #0e4ead;\r\n            --mdc-theme-background: #E0E0E0;\r\n            } \r\n            main {\r\n            margin: 0px auto;\r\n            }\r\n            .mdc-card {\r\n            margin-bottom: 20px;\r\n            padding: 8px;\r\n            }\r\n        <\/style>\r\n        \r\n        <style media=\"screen\">\r\n            body { background: #ECEFF1; color: rgba(0,0,0,0.87); font-family: Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }\r\n            #message { background: white; max-width: 360px; margin: 100px auto 16px; padding: 32px 24px; border-radius: 3px; }\r\n            #message h2 { color: #ffa100; font-weight: bold; font-size: 16px; margin: 0 0 8px; }\r\n            #message h1 { font-size: 22px; font-weight: 300; color: rgba(0,0,0,0.6); margin: 0 0 16px;}\r\n            #message p { line-height: 140%; margin: 16px 0 24px; font-size: 14px; }\r\n            #message a { display: block; text-align: center; background: #039be5; text-transform: uppercase; text-decoration: none; color: white; padding: 16px; border-radius: 4px; }\r\n            #message, #message a { box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); }\r\n            #load { color: rgba(0,0,0,0.4); text-align: center; font-size: 13px; }\r\n            @media (max-width: 600px) {\r\n            body, #message { margin-top: 0; background: white; box-shadow: none; }\r\n            body { border-top: 16px solid #ffa100; }\r\n            }\r\n        <\/style>\r\n        <\/head>\r\n        <body>\r\n        <header class=\"mdc-toolbar mdc-toolbar--fixed\">\r\n            <div class=\"mdc-toolbar__row\">\r\n            <section class=\"mdc-toolbar__section mdc-toolbar__section--align-start\">\r\n                <span class=\"mdc-toolbar__title\">esp-nodejs-mqtt - Cloud IoT Core<\/span>\r\n            <\/section>\r\n            <!--\r\n                <section class=\"mdc-toolbar__section mdc-toolbar__section--align-end\" role=\"toolbar\">\r\n                    <a href=\"#\" class=\"material-icons mdc-toolbar__icon\" aria-label=\"Download\" alt=\"Download\">more_vert<\/a>\r\n                <\/section>\r\n                -->\r\n            <\/div>\r\n        <\/header>\r\n        <main class=\"mdc-toolbar-fixed-adjust\">\r\n            <div class=\"mdc-layout-grid\">\r\n            <div class=\"mdc-layout-grid__inner\">\r\n                <div class=\"mdc-layout-grid__cell mdc-layout-grid__cell--span-12\">\r\n                <div class=\"mdc-card\">\r\n                    <section class=\"mdc-card__primary\">\r\n                    <p id=\"load\">Firebase SDK Loading\u2026<\/p>\r\n                    <h1 class=\"mdc-card__title mdc-card__title--large\">Current data collected<\/h1>\r\n                    <\/section>\r\n                    <ul id=\"devices\" class=\"mdc-list mdc-list--two-line mdc-list--avatar-list two-line-avatar-text-icon-demo\">\r\n                    <div role=\"progressbar\" class=\"mdc-linear-progress mdc-linear-progress--indeterminate\">\r\n                        <div class=\"mdc-linear-progress__buffering-dots\"><\/div>\r\n                        <div class=\"mdc-linear-progress__buffer\"><\/div>\r\n                        <div class=\"mdc-linear-progress__bar mdc-linear-progress__primary-bar\">\r\n                        <span class=\"mdc-linear-progress__bar-inner\"><\/span>\r\n                        <\/div>\r\n                        <div class=\"mdc-linear-progress__bar mdc-linear-progress__secondary-bar\">\r\n                        <span class=\"mdc-linear-progress__bar-inner\"><\/span>\r\n                        <\/div>\r\n                    <\/div>\r\n                    <\/ul>\r\n                <\/div>\r\n                <\/div>\r\n                <div class=\"mdc-layout-grid__cell mdc-layout-grid__cell--span-6\">\r\n                <div class=\"mdc-card\">\r\n                    <section class=\"mdc-card__primary\">\r\n                    <h1 class=\"mdc-card__title mdc-card__title--large\">Temperature - Last 7 days<\/h1>\r\n                    <\/section>\r\n                    <canvas id=\"tempLineChart\"><\/canvas>\r\n                    <div role=\"progressbar\" id=\"tempLineChart_progress\" class=\"mdc-linear-progress mdc-linear-progress--indeterminate\">\r\n                    <div class=\"mdc-linear-progress__buffering-dots\"><\/div>\r\n                    <div class=\"mdc-linear-progress__buffer\"><\/div>\r\n                    <div class=\"mdc-linear-progress__bar mdc-linear-progress__primary-bar\">\r\n                        <span class=\"mdc-linear-progress__bar-inner\"><\/span>\r\n                    <\/div>\r\n                    <div class=\"mdc-linear-progress__bar mdc-linear-progress__secondary-bar\">\r\n                        <span class=\"mdc-linear-progress__bar-inner\"><\/span>\r\n                    <\/div>\r\n                    <\/div>\r\n                <\/div>\r\n                <\/div>\r\n                <div class=\"mdc-layout-grid__cell mdc-layout-grid__cell--span-6\">\r\n                <div class=\"mdc-card\">\r\n                    <section class=\"mdc-card__primary\">\r\n                    <h1 class=\"mdc-card__title mdc-card__title--large\">Humidity - Last 7 days<\/h1>\r\n                    <\/section>\r\n                    <canvas id=\"humLineChart\"><\/canvas>\r\n                    <div role=\"progressbar\" id=\"humLineChart_progress\" class=\"mdc-linear-progress mdc-linear-progress--indeterminate\">\r\n                    <div class=\"mdc-linear-progress__buffering-dots\"><\/div>\r\n                    <div class=\"mdc-linear-progress__buffer\"><\/div>\r\n                    <div class=\"mdc-linear-progress__bar mdc-linear-progress__primary-bar\">\r\n                        <span class=\"mdc-linear-progress__bar-inner\"><\/span>\r\n                    <\/div>\r\n                    <div class=\"mdc-linear-progress__bar mdc-linear-progress__secondary-bar\">\r\n                        <span class=\"mdc-linear-progress__bar-inner\"><\/span>\r\n                    <\/div>\r\n                    <\/div>\r\n                <\/div>\r\n                <\/div>\r\n            <\/div>\r\n            <\/div>\r\n        <\/main>\r\n        <script src=\"https:\/\/unpkg.com\/material-components-web@latest\/dist\/material-components-web.min.js\"><\/script>\r\n        <script src=\"https:\/\/cdnjs.cloudflare.com\/ajax\/libs\/Chart.js\/2.5.0\/Chart.bundle.min.js\"><\/script>\r\n        <script>\r\n            window.mdc.autoInit();\r\n        <\/script>\r\n        <\/body>\r\n    <\/html><\/pre>\r\n        <\/li>\r\n        <li>\r\n            Add JavaScript code for the web page to <code>public\\app.js<\/code>\r\n            <pre class=\"brush: jscript; gutter: true; highlight: [56]; light: false; title: ; toolbar: false; notranslate\" title=\"\">if( document.readyState === 'complete' ) {\r\n    myInitCode();\r\n} else {\r\n    document.addEventListener('DOMContentLoaded', function () {\r\n        myInitCode();\r\n    });\r\n}\r\n\r\nfunction myInitCode() {\r\n    \/\/ attach an async callback to read the data    \r\n    firebase.auth().onAuthStateChanged(user => {\r\n    if (user) {\r\n            console.log(\"AuthStateChanged - user signed\");\r\n    } else {\r\n            console.log(\"AuthStateChanged - no user signed in\");\r\n    }\r\n    });\r\n    \r\n    firebase.database().ref('devices').on('value', snapshot => {\r\n    console.log(\"value changed\");\r\n    console.log(snapshot.val());\r\n    \r\n    let devices = snapshot.val();\r\n    console.log(devices);\r\n    let devicesEl = document.getElementById('devices');\r\n    devicesEl.innerHTML = '';\r\n    \r\n    for (var key in devices) {\r\n            let deviceState = devices[key];\r\n            let li = document.createElement('li');\r\n            li.className = 'mdc-list-item';\r\n            li.innerHTML = `\r\n        <span class=\"mdc-list-item__start-detail grey-bg\" role=\"presentation\">\r\n            <i class=\"material-icons\" aria-hidden=\"true\">cloud<\/i>\r\n        <\/span>\r\n        <span class=\"mdc-list-item__text\">\r\n            Station #${key}\r\n            <span class=\"mdc-list-item__text__secondary\">\r\n                ${deviceState.temp} C\u00c2\u00b0\/${deviceState.humidity} %\r\n            <\/span>\r\n            <span class=\"mdc-list-item__text__secondary\">\r\n                Last updated: ${new Date(deviceState.timestamp).toLocaleString()}\r\n            <\/span>\r\n        <\/span>\r\n        `;\r\n        \r\n            devicesEl.appendChild(li);\r\n    }\r\n    }, function(errorObject) {\r\n    console.log(\"The read failed: \" + errorObject.code);\r\n    });\r\n    \r\n    fetchReportData();\r\n}\r\n\r\nconst reportDataUrl = 'https:\/\/us-central1-YOURPROJECTID.cloudfunctions.net\/getWeek';\r\n\r\nfunction fetchReportData() {\r\n    try {\r\n    fetch(reportDataUrl)\r\n            .then(res => res.json())\r\n            .then(rows => {\r\n        var maxTempData = rows.map(row => row.max_temp);\r\n        var avgTempData = rows.map(row => row.avg_temp);\r\n        var minTempData = rows.map(row => row.min_temp);\r\n        \r\n        var maxHumData = rows.map(row => row.max_hum);\r\n        var avgHumData = rows.map(row => row.avg_hum);\r\n        var minHumData = rows.map(row => row.min_hum);\r\n        \r\n        var labels = rows.map(row => row.data_hour.value);\r\n        \r\n        buildLineChart(\r\n            'tempLineChart',\r\n            'Temperature in C\u00c2\u00b0',\r\n            labels,\r\n            '#E64D3D',\r\n            avgTempData\r\n        );\r\n        buildLineChart(\r\n            'humLineChart',\r\n            'Humidity in %',\r\n            labels,\r\n            '#0393FA',\r\n            avgHumData\r\n        );\r\n            });\r\n    } catch (e) {\r\n    alert('Error getting report data');\r\n    }\r\n}\r\n\r\nfunction buildLineChart(el, label, labels, color, avgData) {\r\n    const elNode = document.getElementById(el);\r\n    new Chart(elNode, {\r\n    type: 'line',\r\n    data: {\r\n            labels: labels,\r\n            datasets: [\r\n        {\r\n            label: label,\r\n            data: avgData,\r\n            borderWidth: 1,\r\n            fill: true,\r\n            spanGaps: true,\r\n            lineTension: 0.2,\r\n            backgroundColor: color,\r\n            borderColor: '#3A4250',\r\n            pointRadius: 2\r\n        }\r\n            ]\r\n    },\r\n    options: {\r\n            responsive: true,\r\n            scales: {\r\n        xAxes: [\r\n            {\r\n            type: 'time',\r\n            distribution: 'series',\r\n            ticks: {\r\n                source: 'labels'\r\n            }\r\n            }\r\n        ],\r\n        yAxes: [\r\n            {\r\n            scaleLabel: {\r\n                display: true,\r\n                labelString: label\r\n            },\r\n            ticks: {\r\n                stepSize: 0.5\r\n            }\r\n            }\r\n        ]\r\n            }\r\n    }\r\n    });\r\n    \r\n    const progressEl = document.getElementById(el + '_progress');\r\n    progressEl.remove();\r\n    \r\n    try {\r\n        let app = firebase.app();\r\n        let features = ['auth', 'database', 'messaging', 'storage'].filter(feature => typeof app[feature] === 'function');\r\n        document.getElementById('load').innerHTML = `Firebase SDK loaded with ${features.join(', ')}`;\r\n    } catch (e) {\r\n        console.error(e);\r\n        document.getElementById('load').innerHTML = 'Error loading the Firebase SDK, check the console.';\r\n    }\r\n    \r\n}<\/pre><\/li>\r\n    <\/ol>\r\n<\/p>\r\n\r\n<h3>\r\n    Deploy\r\n<\/h3>\r\n<p>\r\n    <pre class=\"brush: powershell; gutter: true; title: ; toolbar: false; notranslate\" title=\"\">firebase deploy<\/pre>\r\n<\/p>\r\n\r\n<h3>\r\n    Expected results and debugging\r\n<\/h3>\r\n<p>\r\n    The WebApp should look similar as shown in the figure below\r\n\r\n    <div class=\"align-center\">\r\n        <figure>\r\n            <div class=\"flex-container tight\">\r\n                <a href=\"\/wp-content\/uploads\/esp-nodejs-mqtt.firebaseapp.com_Nexus-5X.png\">\r\n                    <img src=\"https:\/\/coert.vonk.one\/wp-content\/uploads\/esp-nodejs-mqtt.firebaseapp.com_Nexus-5X.png\" alt=\"\" class=\"alignnone size-full wp-image-24350\" width=\"400\" srcset=\"https:\/\/coert.vonk.one\/wp-content\/uploads\/esp-nodejs-mqtt.firebaseapp.com_Nexus-5X.png 1082w, https:\/\/coert.vonk.one\/wp-content\/uploads\/esp-nodejs-mqtt.firebaseapp.com_Nexus-5X-225x400.png 225w, https:\/\/coert.vonk.one\/wp-content\/uploads\/esp-nodejs-mqtt.firebaseapp.com_Nexus-5X-768x1364.png 768w, https:\/\/coert.vonk.one\/wp-content\/uploads\/esp-nodejs-mqtt.firebaseapp.com_Nexus-5X-576x1024.png 576w\" sizes=\"(max-width: 706px) 89vw, (max-width: 767px) 82vw, 740px\" \/>\r\n                <\/a>\r\n            <\/div>\r\n            <figcaption>\r\n                WebApp on a Nexus 5X\r\n            <\/figcaption>\r\n        <\/figure>\r\n    <\/div>\r\n<\/p>\r\n\r\n<h2>\r\n    Credits\r\n<\/h2>\r\n<p>\r\n    <div class=\"flex-container\">\r\n        <table>\r\n            <tr>\r\n                <td style=\"vertical-align:top;\">[1]<\/td>\r\n                <td><em>Talk to your CD player using Google Home<\/em><br>\r\n                Sander Vonk, 2017-Oct-15, retrieved 2018-02-16.<br>\r\n                coert.vonk.one\/sw\/embedded\/google-home-ifttt-esp8266-integration-23066<\/td>\r\n            <\/tr>\r\n            <tr>\r\n                <td style=\"vertical-align:top;\">[2]<\/td>\r\n                <td><em>Itead Sonoff S20 + MQTT + Google Assistant<\/em><br>\r\n                Coert Vonk, 2018-Mar-01, retrieved 2018-Mar-01.<br>\r\n                github.com\/cvonk\/esp8285-mqtt_light<\/td>\r\n            <\/tr>\r\n                <tr>\r\n                <td style=\"vertical-align:top;\">[3]<\/td>\r\n                <td><em>Build a Weather Station using Google Cloud IoT Core and MongooseOS<\/em><br>\r\n                Alvaro Viebrantz, 2017-Oct-15, retrieved 2018-Feb-16.<br>\r\n                medium.com\/google-cloud\/build-a-weather-station-using-google-cloud-iot-core-and-mongooseos-7a78b69822c5<\/td>\r\n            <\/tr>\r\n            <tr>\r\n                <td style=\"vertical-align:top;\">[4]<\/td>\r\n                <td><em>Overview of Internet of Things<\/em><br>\r\n                Google, 2017-Sep-28, retrieved 2018-Mar-17.<br>\r\n                cloud.google.com\/solutions\/iot-overview<\/td>\r\n            <\/tr>\r\n        <\/table>\r\n    <\/div>\r\n<\/p>\r\n<p>\r\n    create and register device by hand\r\n    <blockquote class=\"wp-embedded-content\" data-secret=\"0HzoMwnN8P\"><a href=\"https:\/\/www.amebaiot.com\/en\/google-cloud-iot\/\">Ameba : Getting Started With Google Cloud IoT<\/a><\/blockquote><iframe class=\"wp-embedded-content\" sandbox=\"allow-scripts\" security=\"restricted\" style=\"position: absolute; clip: rect(1px, 1px, 1px, 1px);\" src=\"https:\/\/www.amebaiot.com\/en\/google-cloud-iot\/embed\/#?secret=0HzoMwnN8P\" data-secret=\"0HzoMwnN8P\" width=\"525\" height=\"296\" title=\"&#8220;Ameba : Getting Started With Google Cloud IoT&#8221; &#8212; Realtek IoT\/Arduino Solution\" frameborder=\"0\" marginwidth=\"0\" marginheight=\"0\" scrolling=\"no\"><\/iframe>\r\n<\/p>\r\n<p>\r\n    Google Assistant integration:\r\n    https:\/\/codelabs.developers.google.com\/codelabs\/assistant-codelab\/index.html?index=..%2F..%2Findex#0    \r\n<\/p>\r\n","protected":false},"excerpt":{"rendered":"This tutorial gives you a glimpse on integrating IoT devices with Google&#8217;s ecosystem.  This approach is scalable to a great many devices, has security designed in an only relies on the IoT device and Google Cloud Platform.  ","protected":false},"author":41,"featured_media":0,"comment_status":"open","ping_status":"closed","sticky":false,"template":"","format":"standard","meta":{"inline_featured_image":false,"_mi_skip_tracking":false},"categories":[435],"tags":[],"yoast_head":"<!-- This site is optimized with the Yoast SEO plugin v18.6 - https:\/\/yoast.com\/wordpress\/plugins\/seo\/ -->\n<title>Google IoT meets ESP32, MQTT, NodeJS - Coert Vonk<\/title>\n<meta name=\"description\" content=\"A glimpse on integrating IoT devices with Google&#039;s ecosystem. This approach is scalable, has security designed in an only relies on the IoT device and GCP.\" \/>\n<meta name=\"robots\" content=\"index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1\" \/>\n<link rel=\"canonical\" href=\"https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997\" \/>\n<meta property=\"og:locale\" content=\"en_US\" \/>\n<meta property=\"og:type\" content=\"article\" \/>\n<meta property=\"og:title\" content=\"Google IoT meets ESP32, MQTT, NodeJS - Coert Vonk\" \/>\n<meta property=\"og:description\" content=\"A glimpse on integrating IoT devices with Google&#039;s ecosystem. This approach is scalable, has security designed in an only relies on the IoT device and GCP.\" \/>\n<meta property=\"og:url\" content=\"https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997\" \/>\n<meta property=\"og:site_name\" content=\"Coert Vonk\" \/>\n<meta property=\"article:published_time\" content=\"2018-02-24T01:30:14+00:00\" \/>\n<meta property=\"article:modified_time\" content=\"2022-04-30T03:01:31+00:00\" \/>\n<meta property=\"og:image\" content=\"https:\/\/coert.vonk.one\/wp-content\/uploads\/block-diagram-overview.svg\" \/>\n<meta name=\"twitter:card\" content=\"summary\" \/>\n<meta name=\"twitter:label1\" content=\"Written by\" \/>\n\t<meta name=\"twitter:data1\" content=\"Coert Vonk\" \/>\n\t<meta name=\"twitter:label2\" content=\"Est. reading time\" \/>\n\t<meta name=\"twitter:data2\" content=\"24 minutes\" \/>\n<script type=\"application\/ld+json\" class=\"yoast-schema-graph\">{\"@context\":\"https:\/\/schema.org\",\"@graph\":[{\"@type\":\"WebSite\",\"@id\":\"https:\/\/coert.vonk.one\/#website\",\"url\":\"https:\/\/coert.vonk.one\/\",\"name\":\"Coert Vonk\",\"description\":\"Embedded Software Engineer\",\"publisher\":{\"@id\":\"https:\/\/coert.vonk.one\/#\/schema\/person\/5eeda746b43b88312a0621fdc226c70e\"},\"potentialAction\":[{\"@type\":\"SearchAction\",\"target\":{\"@type\":\"EntryPoint\",\"urlTemplate\":\"https:\/\/coert.vonk.one\/?s={search_term_string}\"},\"query-input\":\"required name=search_term_string\"}],\"inLanguage\":\"en-US\"},{\"@type\":\"ImageObject\",\"@id\":\"https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997#primaryimage\",\"inLanguage\":\"en-US\",\"url\":\"https:\/\/coert.vonk.one\/wp-content\/uploads\/block-diagram-overview.svg\",\"contentUrl\":\"https:\/\/coert.vonk.one\/wp-content\/uploads\/block-diagram-overview.svg\"},{\"@type\":\"WebPage\",\"@id\":\"https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997#webpage\",\"url\":\"https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997\",\"name\":\"Google IoT meets ESP32, MQTT, NodeJS - Coert Vonk\",\"isPartOf\":{\"@id\":\"https:\/\/coert.vonk.one\/#website\"},\"primaryImageOfPage\":{\"@id\":\"https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997#primaryimage\"},\"datePublished\":\"2018-02-24T01:30:14+00:00\",\"dateModified\":\"2022-04-30T03:01:31+00:00\",\"description\":\"A glimpse on integrating IoT devices with Google's ecosystem. This approach is scalable, has security designed in an only relies on the IoT device and GCP.\",\"breadcrumb\":{\"@id\":\"https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997#breadcrumb\"},\"inLanguage\":\"en-US\",\"potentialAction\":[{\"@type\":\"ReadAction\",\"target\":[\"https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997\"]}]},{\"@type\":\"BreadcrumbList\",\"@id\":\"https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997#breadcrumb\",\"itemListElement\":[{\"@type\":\"ListItem\",\"position\":1,\"name\":\"Vonk Family\",\"item\":\"https:\/\/coert.vonk.one\/\"},{\"@type\":\"ListItem\",\"position\":2,\"name\":\"Software\",\"item\":\"https:\/\/coert.vonk.one\/category\/sw\"},{\"@type\":\"ListItem\",\"position\":3,\"name\":\"IoT\",\"item\":\"https:\/\/coert.vonk.one\/category\/sw\/iot\"},{\"@type\":\"ListItem\",\"position\":4,\"name\":\"Google IoT meets ESP32, MQTT, NodeJS\"}]},{\"@type\":\"Article\",\"@id\":\"https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997#article\",\"isPartOf\":{\"@id\":\"https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997#webpage\"},\"author\":{\"@id\":\"https:\/\/coert.vonk.one\/#\/schema\/person\/5eeda746b43b88312a0621fdc226c70e\"},\"headline\":\"Google IoT meets ESP32, MQTT, NodeJS\",\"datePublished\":\"2018-02-24T01:30:14+00:00\",\"dateModified\":\"2022-04-30T03:01:31+00:00\",\"mainEntityOfPage\":{\"@id\":\"https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997#webpage\"},\"wordCount\":4705,\"commentCount\":0,\"publisher\":{\"@id\":\"https:\/\/coert.vonk.one\/#\/schema\/person\/5eeda746b43b88312a0621fdc226c70e\"},\"image\":{\"@id\":\"https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997#primaryimage\"},\"thumbnailUrl\":\"https:\/\/coert.vonk.one\/wp-content\/uploads\/block-diagram-overview.svg\",\"articleSection\":[\"IoT\"],\"inLanguage\":\"en-US\"},{\"@type\":[\"Person\",\"Organization\"],\"@id\":\"https:\/\/coert.vonk.one\/#\/schema\/person\/5eeda746b43b88312a0621fdc226c70e\",\"name\":\"Coert Vonk\",\"image\":{\"@type\":\"ImageObject\",\"@id\":\"https:\/\/coert.vonk.one\/#personlogo\",\"inLanguage\":\"en-US\",\"url\":\"http:\/\/1.gravatar.com\/avatar\/193315b96c6661985694e2ecd91f2996?s=96&d=mm&r=g\",\"contentUrl\":\"http:\/\/1.gravatar.com\/avatar\/193315b96c6661985694e2ecd91f2996?s=96&d=mm&r=g\",\"caption\":\"Coert Vonk\"},\"logo\":{\"@id\":\"https:\/\/coert.vonk.one\/#personlogo\"},\"description\":\"Passionately curious and stubbornly persistent. Enjoys to inspire and consult with others to exchange the poetry of logical ideas.\",\"sameAs\":[\"https:\/\/coert.vonk.one\"],\"url\":\"/\/author\/cvonk\"}]}<\/script>\n<!-- \/ Yoast SEO plugin. -->","yoast_head_json":{"title":"Google IoT meets ESP32, MQTT, NodeJS - Coert Vonk","description":"A glimpse on integrating IoT devices with Google's ecosystem. This approach is scalable, has security designed in an only relies on the IoT device and GCP.","robots":{"index":"index","follow":"follow","max-snippet":"max-snippet:-1","max-image-preview":"max-image-preview:large","max-video-preview":"max-video-preview:-1"},"canonical":"https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997","og_locale":"en_US","og_type":"article","og_title":"Google IoT meets ESP32, MQTT, NodeJS - Coert Vonk","og_description":"A glimpse on integrating IoT devices with Google's ecosystem. This approach is scalable, has security designed in an only relies on the IoT device and GCP.","og_url":"https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997","og_site_name":"Coert Vonk","article_published_time":"2018-02-24T01:30:14+00:00","article_modified_time":"2022-04-30T03:01:31+00:00","og_image":[{"url":"https:\/\/coert.vonk.one\/wp-content\/uploads\/block-diagram-overview.svg"}],"twitter_card":"summary","twitter_misc":{"Written by":"Coert Vonk","Est. reading time":"24 minutes"},"schema":{"@context":"https:\/\/schema.org","@graph":[{"@type":"WebSite","@id":"https:\/\/coert.vonk.one\/#website","url":"https:\/\/coert.vonk.one\/","name":"Coert Vonk","description":"Embedded Software Engineer","publisher":{"@id":"https:\/\/coert.vonk.one\/#\/schema\/person\/5eeda746b43b88312a0621fdc226c70e"},"potentialAction":[{"@type":"SearchAction","target":{"@type":"EntryPoint","urlTemplate":"https:\/\/coert.vonk.one\/?s={search_term_string}"},"query-input":"required name=search_term_string"}],"inLanguage":"en-US"},{"@type":"ImageObject","@id":"https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997#primaryimage","inLanguage":"en-US","url":"https:\/\/coert.vonk.one\/wp-content\/uploads\/block-diagram-overview.svg","contentUrl":"https:\/\/coert.vonk.one\/wp-content\/uploads\/block-diagram-overview.svg"},{"@type":"WebPage","@id":"https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997#webpage","url":"https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997","name":"Google IoT meets ESP32, MQTT, NodeJS - Coert Vonk","isPartOf":{"@id":"https:\/\/coert.vonk.one\/#website"},"primaryImageOfPage":{"@id":"https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997#primaryimage"},"datePublished":"2018-02-24T01:30:14+00:00","dateModified":"2022-04-30T03:01:31+00:00","description":"A glimpse on integrating IoT devices with Google's ecosystem. This approach is scalable, has security designed in an only relies on the IoT device and GCP.","breadcrumb":{"@id":"https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997#breadcrumb"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997"]}]},{"@type":"BreadcrumbList","@id":"https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997#breadcrumb","itemListElement":[{"@type":"ListItem","position":1,"name":"Vonk Family","item":"https:\/\/coert.vonk.one\/"},{"@type":"ListItem","position":2,"name":"Software","item":"https:\/\/coert.vonk.one\/category\/sw"},{"@type":"ListItem","position":3,"name":"IoT","item":"https:\/\/coert.vonk.one\/category\/sw\/iot"},{"@type":"ListItem","position":4,"name":"Google IoT meets ESP32, MQTT, NodeJS"}]},{"@type":"Article","@id":"https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997#article","isPartOf":{"@id":"https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997#webpage"},"author":{"@id":"https:\/\/coert.vonk.one\/#\/schema\/person\/5eeda746b43b88312a0621fdc226c70e"},"headline":"Google IoT meets ESP32, MQTT, NodeJS","datePublished":"2018-02-24T01:30:14+00:00","dateModified":"2022-04-30T03:01:31+00:00","mainEntityOfPage":{"@id":"https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997#webpage"},"wordCount":4705,"commentCount":0,"publisher":{"@id":"https:\/\/coert.vonk.one\/#\/schema\/person\/5eeda746b43b88312a0621fdc226c70e"},"image":{"@id":"https:\/\/coert.vonk.one\/sw\/iot\/sonoff-mqtt-google-actions-23997#primaryimage"},"thumbnailUrl":"https:\/\/coert.vonk.one\/wp-content\/uploads\/block-diagram-overview.svg","articleSection":["IoT"],"inLanguage":"en-US"},{"@type":["Person","Organization"],"@id":"https:\/\/coert.vonk.one\/#\/schema\/person\/5eeda746b43b88312a0621fdc226c70e","name":"Coert Vonk","image":{"@type":"ImageObject","@id":"https:\/\/coert.vonk.one\/#personlogo","inLanguage":"en-US","url":"http:\/\/1.gravatar.com\/avatar\/193315b96c6661985694e2ecd91f2996?s=96&d=mm&r=g","contentUrl":"http:\/\/1.gravatar.com\/avatar\/193315b96c6661985694e2ecd91f2996?s=96&d=mm&r=g","caption":"Coert Vonk"},"logo":{"@id":"https:\/\/coert.vonk.one\/#personlogo"},"description":"Passionately curious and stubbornly persistent. Enjoys to inspire and consult with others to exchange the poetry of logical ideas.","sameAs":["https:\/\/coert.vonk.one"],"url":"/\/author\/cvonk"}]}},"_links":{"self":[{"href":"/\/wp-json\/wp\/v2\/posts\/23997"}],"collection":[{"href":"/\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"/\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"/\/wp-json\/wp\/v2\/users\/41"}],"replies":[{"embeddable":true,"href":"/\/wp-json\/wp\/v2\/comments?post=23997"}],"version-history":[{"count":6,"href":"/\/wp-json\/wp\/v2\/posts\/23997\/revisions"}],"predecessor-version":[{"id":32836,"href":"/\/wp-json\/wp\/v2\/posts\/23997\/revisions\/32836"}],"wp:attachment":[{"href":"/\/wp-json\/wp\/v2\/media?parent=23997"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"/\/wp-json\/wp\/v2\/categories?post=23997"},{"taxonomy":"post_tag","embeddable":true,"href":"/\/wp-json\/wp\/v2\/tags?post=23997"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}